<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Áä¨„ÅÆÈºª„É©„Éô„É™„É≥„Ç∞ÁÆ°ÁêÜ„ÉÑ„Éº„É´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
			padding-top: 80px; /* „Éò„ÉÉ„ÉÄ„ÉºÂàÜ„ÅÆ‰ΩôÁôΩ */
		}
		.header {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 20px;
			border-radius: 10px;
			margin-bottom: 20px;
			text-align: center;
		}
		.header h1 {
			font-size: 2.5em;
			margin-bottom: 10px;
		}
		.header p {
			font-size: 1.1em;
			opacity: 0.9;
		}

        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .image-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .control-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .image-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .image-display {
            max-width: 100%;
            max-height: 500px;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .image-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .image-info h3 {
            color: #495057;
            margin-bottom: 10px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .nav-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .nav-button:hover {
            background: #0056b3;
        }

        .nav-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .image-counter {
            font-weight: bold;
            font-size: 18px;
        }

        .label-section {
            margin-bottom: 20px;
        }

        .label-section h3 {
            margin-bottom: 15px;
            color: #495057;
        }

        .label-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .label-button {
            padding: 15px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            font-weight: bold;
        }

        .label-button:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }

        .label-button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .label-button.nose {
            border-color: #28a745;
        }

        .label-button.nose.active {
            background: #28a745;
            border-color: #28a745;
        }


        .sub-labels {
            margin-bottom: 20px;
        }

        .sub-label-group {
            margin-bottom: 15px;
        }

        .sub-label-group h4 {
            margin-bottom: 8px;
            color: #6c757d;
        }

        .sub-label-options {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .sub-label-option {
            padding: 5px 10px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .sub-label-option:hover {
            border-color: #007bff;
        }

        .sub-label-option.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .dataset-split {
            margin-bottom: 20px;
        }

        .split-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
        }

        .split-button {
            padding: 8px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .split-button:hover {
            border-color: #007bff;
        }

        .split-button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .save-button {
            width: 100%;
            padding: 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 20px;
            transition: background-color 0.3s;
        }

        .save-button:hover {
            background: #218838;
        }

        .export-section {
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }

        .export-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .export-button {
            padding: 10px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .export-button:hover {
            background: #5a6268;
        }

        .shortcuts {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .shortcut-key {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }

        .no-images {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    {% include 'header.html' with context %}
    <div class="container" style="padding-top:80px;">
        <div class="header">
            <h1>üêï Áä¨„ÅÆÈºª„É©„Éô„É™„É≥„Ç∞ÁÆ°ÁêÜ„ÉÑ„Éº„É´</h1>
            <p>Áä¨„ÅÆÈ°îÁîªÂÉè„Åã„ÇâÈºª„ÅÆÊúâÁÑ°„ÇíÂà§ÂÆö„Åó„ÄÅÊ©üÊ¢∞Â≠¶ÁøíÁî®„Éá„Éº„Çø„Çª„ÉÉ„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åô</p>
        </div>

        <div class="main-content">
            <div class="image-section">
                <div class="navigation">
                    <button class="nav-button" id="prevBtn" onclick="previousImage()">‚Üê Ââç„ÅÆÁîªÂÉè</button>
                    <div class="image-counter">
                        <span id="currentIndex">0</span> / <span id="totalImages">0</span>
                    </div>
                    <button class="nav-button" id="nextBtn" onclick="nextImage()">Ê¨°„ÅÆÁîªÂÉè ‚Üí</button>
                </div>

                <div class="image-container" id="imageContainer" style="display: flex; align-items: center; gap: 32px; min-height: 500px;">
                    <div style="flex-shrink:0;">
                        <div class="loading">ÁîªÂÉè„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                        <!-- ÁîªÂÉè„Å®canvas„ÇíÈáç„Å≠„Å¶Ë°®Á§∫„Åô„Çã„É©„ÉÉ„Éë„Éº -->
                        <div id="imageCanvasWrapper" style="position: relative; display: inline-block;">
                            <!-- ÁîªÂÉè„ÅØJS„ÅßÊåøÂÖ• -->
                            <!-- canvas„ÅØÁîªÂÉè„Å®Âêå„Åò„Çµ„Ç§„Ç∫„Éª‰ΩçÁΩÆ„ÅßÈáç„Å≠„Çã -->
                            <canvas id="bboxCanvas" style="position: absolute; left: 0; top: 0; z-index: 2; display: none;"></canvas>
                        </div>
                        <div style="width:100%; display:flex; justify-content:center;">
                            <button id="openOriginalModalBtn" class="nav-button" style="margin-top: 16px; width: auto; min-width: 160px;">ÂÖÉÁîªÂÉè„Çµ„Ç§„Ç∫„ÅßÁ∑®ÈõÜ</button>
                        </div>
                    </div>
        <!-- ÂÖÉÁîªÂÉè„Çµ„Ç§„Ç∫Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
        <div id="originalModal" style="display:none; position:fixed; z-index:10000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
            <div style="background:#fff; border-radius:12px; padding:24px; position:relative; max-width:98vw; max-height:98vh; overflow:auto;">
                <button id="closeOriginalModalBtn" style="position:absolute; right:12px; top:12px; font-size:20px; background:none; border:none; cursor:pointer;">√ó</button>
                <div id="originalModalContent" style="display:flex; flex-direction:column; align-items:center;">
                    <!-- ÂÖÉÁîªÂÉè„Å®canvas„Çí„Åì„Åì„Å´ÂãïÁöÑ„Å´ÊåøÂÖ• -->
                </div>
                <div style="margin-top:16px; text-align:center;">
                    <button id="saveOriginalModalBtn" class="nav-button">Á∑®ÈõÜÂÜÖÂÆπ„Çí‰øùÂ≠ò</button>
                </div>
            </div>
        </div>
                    <div style="flex:1; display:flex; justify-content:center; align-items:center; min-width:0;">
                        <div id="croppedBoxWrapper" style="min-width:120px; max-width:400px; display:none; text-align:center; align-self:center; width:100%;">
                            <div style="font-size:13px;color:#888;margin-bottom:4px;">ÈºªÈ†òÂüü„Éó„É¨„Éì„É•„Éº</div>
                            <div style="display:flex;justify-content:center;align-items:center;">
                                <canvas id="croppedBoxCanvas" style="border:2px solid #aaa; border-radius:12px; background:#fff; max-width:100%; max-height:400px; display:block;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="image-info" id="imageInfo" style="display: none;">
                    <h3>ÁîªÂÉèÊÉÖÂ†±</h3>
                    <div class="info-item">
                        <span>„Éï„Ç°„Ç§„É´Âêç:</span>
                        <span id="fileName">-</span>
                    </div>
                    <div class="info-item">
                        <span>„Éë„Çπ:</span>
                        <span id="filePath">-</span>
                    </div>
                    <div class="info-item">
                        <span>ÁèæÂú®„ÅÆ„É©„Éô„É´:</span>
                        <span id="currentLabel">Êú™Ë®≠ÂÆö</span>
                    </div>
                    <div class="info-item">
                        <span>BBox:</span>
                        <span id="bboxInfo">-</span>
                    </div>
                    <div class="info-item">
                        <span>‰ΩúÊ•≠Ê∏à„Åø:</span>
                        <span id="isCompletedInfo">-</span>
                    </div>
                </div>
            </div>

            <div class="control-panel">
                <div class="label-section">
                    <h3>„É°„Ç§„É≥„É©„Éô„É´</h3>
                    <div class="label-buttons">
                        <button class="label-button nose" onclick="setMainLabel('nose')">
                            üêΩ Èºª„ÅÇ„Çä (1)
                        </button>
                    </div>
                </div>

                <div class="sub-labels">
                    <h3>„Çµ„Éñ„É©„Éô„É´</h3>
                    <div class="sub-label-group">
                        <h4>Èºª„ÅÆÂêë„Åç</h4>
                        <div class="sub-label-options">
                            <span class="sub-label-option" data-label="front" onclick="toggleSubLabel('front')">Ê≠£Èù¢ (F)</span>
                            <span class="sub-label-option" data-label="side" onclick="toggleSubLabel('side')">Ê®™Âêë„Åç (S)</span>
                            <span class="sub-label-option" data-label="tilted" onclick="toggleSubLabel('tilted')">Êñú„ÇÅ (T)</span>
                        </div>
                    </div>
                    <div class="sub-label-group">
                        <h4>ÈÆÆÊòéÂà§ÂÆö</h4>
                        <div class="sub-label-options">
                            <span class="sub-label-option" data-label="clear" onclick="toggleSubLabel('clear')">ÈÆÆÊòé (C)</span>
                            <span class="sub-label-option" data-label="blurred" onclick="toggleSubLabel('blurred')">„Åº„ÇÑ„Åë (B)</span>
                        </div>
                    </div>
                    <div class="sub-label-group">
                        <h4>Èºª„ÅÆËâ≤</h4>
                        <div class="sub-label-options">
                            <span class="sub-label-option" data-label="black" onclick="toggleSubLabel('black')">Èªí (K)</span>
                            <span class="sub-label-option" data-label="brown" onclick="toggleSubLabel('brown')">Ëå∂Ëâ≤ (R)</span>
                            <span class="sub-label-option" data-label="gray" onclick="toggleSubLabel('gray')">ÁÅ∞Ëâ≤ (G)</span>
                            <span class="sub-label-option" data-label="pink" onclick="toggleSubLabel('pink')">„Éî„É≥„ÇØ (P)</span>
                            <span class="sub-label-option" data-label="marble" onclick="toggleSubLabel('marble')">„Éû„Éº„Éñ„É´ (M)</span>
                        </div>
                    </div>
                    <div class="sub-label-group">
                        <h4>Èºª„ÅÆÂ§ß„Åç„Åï</h4>
                        <div class="sub-label-options">
                            <span class="sub-label-option" data-label="large" onclick="toggleSubLabel('large')">Â§ß„Åç„ÅÑ (L)</span>
                            <span class="sub-label-option" data-label="small" onclick="toggleSubLabel('small')">Â∞è„Åï„ÅÑ (Q)</span>
                        </div>
                    </div>
                    <div class="sub-label-group">
                        <h4>ÊØõËâ≤</h4>
                        <div class="sub-label-options">
                            <span class="sub-label-option" data-label="light_fur" onclick="toggleSubLabel('light_fur')">Êòé„Çã„ÅÑÊØõËâ≤ (J)</span>
                            <span class="sub-label-option" data-label="dark_fur" onclick="toggleSubLabel('dark_fur')">Êöó„ÅÑÊØõËâ≤ (N)</span>
                        </div>
                    </div>
                </div>

                <div class="dataset-split">
                    <h3>„Éá„Éº„Çø„Çª„ÉÉ„ÉàÂàÜÂâ≤</h3>
                    <div class="split-buttons">
                        <button class="split-button" onclick="setDatasetSplit('train')">Train</button>
                        <button class="split-button" onclick="setDatasetSplit('val')">Val</button>
                        <button class="split-button" onclick="setDatasetSplit('test')">Test</button>
                    </div>
                </div>

                <button class="save-button" onclick="saveLabel()">üíæ „É©„Éô„É´„Çí‰øùÂ≠ò</button>

                <div class="export-section">
                    <div style="margin-top:10px;">
                        <button class="export-button" onclick="exportCurrentImageDataset()">„Åì„ÅÆÁîªÂÉè„Å†„Åë„Éá„Éº„Çø„Çª„ÉÉ„ÉàZIP</button>
                    </div>
                </div>

                <div class="shortcuts">
                    <h4>‚å®Ô∏è „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà</h4>
                    <div class="shortcut-item">
                        <span>Èºª„ÅÇ„Çä:</span>
                        <span class="shortcut-key">1</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Èºª„Å™„Åó:</span>
                        <span class="shortcut-key">2</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Ê≠£Èù¢:</span>
                        <span class="shortcut-key">F</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Ê®™Âêë„Åç:</span>
                        <span class="shortcut-key">S</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Êñú„ÇÅ:</span>
                        <span class="shortcut-key">T</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Êø°„Çå„Å¶„ÅÑ„Çã:</span>
                        <span class="shortcut-key">W</span>
                    </div>
                    <div class="shortcut-item">
                        <span>‰πæ„ÅÑ„Å¶„ÅÑ„Çã:</span>
                        <span class="shortcut-key">D</span>
                    </div>
                    <div class="shortcut-item">
                        <span>„Åº„ÇÑ„Åë„Å¶„ÅÑ„Çã:</span>
                        <span class="shortcut-key">B</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Èªí:</span>
                        <span class="shortcut-key">K</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Ëå∂Ëâ≤:</span>
                        <span class="shortcut-key">R</span>
                    </div>
                    <div class="shortcut-item">
                        <span>„Éî„É≥„ÇØ:</span>
                        <span class="shortcut-key">P</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Ââç„ÅÆÁîªÂÉè:</span>
                        <span class="shortcut-key">‚Üê</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Ê¨°„ÅÆÁîªÂÉè:</span>
                        <span class="shortcut-key">‚Üí</span>
                    </div>
                    <div class="shortcut-item">
                        <span>‰øùÂ≠ò:</span>
                        <span class="shortcut-key">Enter</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // „Åì„ÅÆÁîªÂÉè„Å†„Åë„Éá„Éº„Çø„Çª„ÉÉ„ÉàZIP„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        async function exportCurrentImageDataset() {
            if (!images || images.length === 0) {
                alert('ÁîªÂÉè„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
            const image = images[currentImageIndex];
            if (!image || !image.id) {
                alert('ÁîªÂÉèÊÉÖÂ†±„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì');
                return;
            }
            const btn = document.querySelector('.export-button[onclick="exportCurrentImageDataset()"]');
            if (btn) {
                btn.disabled = true;
                btn.textContent = '„Ç®„ÇØ„Çπ„Éù„Éº„Éà‰∏≠...';
            }
            try {
                const res = await fetch(`/api/export_single/${image.id}`);
                if (!res.ok) throw new Error('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${image.filename.replace(/\.[^.]+$/, '')}_dataset.zip`;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }, 100);
            } catch (e) {
                alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = '„Åì„ÅÆÁîªÂÉè„Å†„Åë„Éá„Éº„Çø„Çª„ÉÉ„ÉàZIP';
                }
            }
        }
        // --- ÂÖÉÁîªÂÉè„Çµ„Ç§„Ç∫Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ ---
        let originalModal = null;
        let originalModalContent = null;
        let originalModalImg = null;
        let originalModalCanvas = null;
        let originalModalCtx = null;
        let originalModalBbox = null;
        let originalModalEditing = false;
        let originalModalStartX = 0, originalModalStartY = 0;
        let originalModalIsDrawing = false;
        let originalModalIsMoving = false;
        let originalModalMoveOffsetX = 0, originalModalMoveOffsetY = 0;
        let originalModalOriginalBbox = null;
        let originalModalResizeCorner = null;
        let originalModalIsResizing = false;

        function setupOriginalModalEvents() {
            if (!originalModalCanvas) return;
            // Êó¢Â≠ò„Ç§„Éô„É≥„Éà„ÇíÈô§Âéª
            originalModalCanvas.onmousedown = null;
            originalModalCanvas.onmousemove = null;
            originalModalCanvas.onmouseup = null;
            // bboxÂèñÂæó
            let bbox = originalModalBbox;
            // Ëßí„Éè„É≥„Éâ„É´Âà§ÂÆö
            function getCornerHandle(x, y, bbox, handleSize = 10) {
                if (!bbox) return null;
                let { x_min, y_min, x_max, y_max } = bbox;
                if (x_min > x_max) [x_min, x_max] = [x_max, x_min];
                if (y_min > y_max) [y_min, y_max] = [y_max, y_min];
                const corners = [
                    { name: 'tl', x: x_min, y: y_min },
                    { name: 'tr', x: x_max, y: y_min },
                    { name: 'bl', x: x_min, y: y_max },
                    { name: 'br', x: x_max, y: y_max }
                ];
                for (const corner of corners) {
                    if (Math.abs(x - corner.x) <= handleSize && Math.abs(y - corner.y) <= handleSize) {
                        return corner.name;
                    }
                }
                return null;
            }
            originalModalCanvas.addEventListener('mousedown', function(e) {
                const rect = originalModalCanvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) * (originalModalCanvas.width / rect.width);
                const y = (e.clientY - rect.top) * (originalModalCanvas.height / rect.height);
                // Ëßí„Éè„É≥„Éâ„É´Âà§ÂÆö
                const corner = bbox ? getCornerHandle(x, y, bbox) : null;
                if (bbox && corner) {
                    // „É™„Çµ„Ç§„Ç∫
                    originalModalIsResizing = true;
                    originalModalResizeCorner = corner;
                    originalModalOriginalBbox = { ...bbox };
                } else if (bbox && x >= bbox.x_min && x <= bbox.x_max && y >= bbox.y_min && y <= bbox.y_max) {
                    // ÁßªÂãï
                    originalModalIsMoving = true;
                    originalModalOriginalBbox = { ...bbox };
                    originalModalMoveOffsetX = x - bbox.x_min;
                    originalModalMoveOffsetY = y - bbox.y_min;
                } else {
                    // Êñ∞Ë¶è‰ΩúÊàê
                    originalModalIsDrawing = true;
                    bbox = { x_min: x, y_min: y, x_max: x, y_max: y };
                }
                originalModalBbox = bbox;
            });
            originalModalCanvas.addEventListener('mousemove', function(e) {
                const rect = originalModalCanvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) * (originalModalCanvas.width / rect.width);
                const y = (e.clientY - rect.top) * (originalModalCanvas.height / rect.height);
                if (originalModalIsDrawing) {
                    bbox.x_max = x;
                    bbox.y_max = y;
                    drawOriginalModalBbox();
                } else if (originalModalIsMoving) {
                    const w = originalModalOriginalBbox.x_max - originalModalOriginalBbox.x_min;
                    const h = originalModalOriginalBbox.y_max - originalModalOriginalBbox.y_min;
                    bbox.x_min = x - originalModalMoveOffsetX;
                    bbox.y_min = y - originalModalMoveOffsetY;
                    bbox.x_max = bbox.x_min + w;
                    bbox.y_max = bbox.y_min + h;
                    drawOriginalModalBbox();
                } else if (originalModalIsResizing) {
                    let { x_min, y_min, x_max, y_max } = originalModalOriginalBbox;
                    switch (originalModalResizeCorner) {
                        case 'tl':
                            bbox.x_min = x;
                            bbox.y_min = y;
                            break;
                        case 'tr':
                            bbox.x_max = x;
                            bbox.y_min = y;
                            break;
                        case 'bl':
                            bbox.x_min = x;
                            bbox.y_max = y;
                            break;
                        case 'br':
                            bbox.x_max = x;
                            bbox.y_max = y;
                            break;
                    }
                    drawOriginalModalBbox();
                }
                originalModalBbox = bbox;
            });
            originalModalCanvas.addEventListener('mouseup', function(e) {
                originalModalIsDrawing = false;
                originalModalIsMoving = false;
                originalModalIsResizing = false;
            });
        }

        function drawOriginalModalBbox() {
            if (!originalModalCanvas || !originalModalBbox) return;
            const ctx = originalModalCanvas.getContext('2d');
            ctx.clearRect(0, 0, originalModalCanvas.width, originalModalCanvas.height);
            const { x_min, y_min, x_max, y_max } = originalModalBbox;
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 3;
            ctx.strokeRect(x_min, y_min, x_max - x_min, y_max - y_min);
            // Ëßí„Éè„É≥„Éâ„É´
            ctx.fillStyle = 'deepskyblue';
            const handleSize = 8;
            [
                [x_min, y_min], [x_max, y_min], [x_min, y_max], [x_max, y_max]
            ].forEach(([cx, cy]) => {
                ctx.fillRect(cx - handleSize/2, cy - handleSize/2, handleSize, handleSize);
            });
        }

        function openOriginalModal(imgUrl, bbox) {
            if (!originalModal) {
                originalModal = document.getElementById('originalModal');
                originalModalContent = document.getElementById('originalModalContent');
            }
            originalModalContent.innerHTML = '';
            originalModalImg = new window.Image();
            originalModalImg.src = imgUrl;
            originalModalImg.onload = function() {
                // ÂÖÉÁîªÂÉè„Çµ„Ç§„Ç∫„ÅßcanvasÁîüÊàê
                originalModalCanvas = document.createElement('canvas');
                originalModalCanvas.width = originalModalImg.naturalWidth;
                originalModalCanvas.height = originalModalImg.naturalHeight;
                originalModalCanvas.style.width = originalModalImg.naturalWidth + 'px';
                originalModalCanvas.style.height = originalModalImg.naturalHeight + 'px';
                originalModalCanvas.style.position = 'absolute';
                originalModalCanvas.style.left = '0';
                originalModalCanvas.style.top = '0';
                originalModalCanvas.style.zIndex = '2';
                // „É©„ÉÉ„Éë„Éº
                const wrapper = document.createElement('div');
                wrapper.style.position = 'relative';
                wrapper.style.display = 'inline-block';
                wrapper.appendChild(originalModalImg);
                wrapper.appendChild(originalModalCanvas);
                originalModalContent.appendChild(wrapper);
                // bboxÂàùÊúüÂÄ§
                if (bbox && typeof bbox === 'object' && 'x_min' in bbox) {
                    originalModalBbox = { ...bbox };
                } else {
                    originalModalBbox = null;
                }
                drawOriginalModalBbox();
                setupOriginalModalEvents();
            };
            originalModal.style.display = 'flex';
        }

        function closeOriginalModal() {
            if (originalModal) originalModal.style.display = 'none';
        }

        function saveOriginalModalBbox() {
            // Á∑®ÈõÜÁµêÊûú„ÇíÂèçÊò†
            if (originalModalBbox) {
                // ÁèæÂú®Ë°®Á§∫‰∏≠ÁîªÂÉè„ÅÆbbox„Å´‰∏äÊõ∏„Åç
                if (images[currentImageIndex]) {
                    images[currentImageIndex].bbox = { ...originalModalBbox };
                }
                // window.currentBbox„Å´„ÇÇÂèçÊò†Ôºà‰øùÂ≠òÊôÇ„Å´Ê≠£„Åó„ÅÑÂÄ§„ÅåÈÄÅ‰ø°„Åï„Çå„Çã„Çà„ÅÜ„Å´Ôºâ
                window.currentBbox = { ...originalModalBbox };
                drawBboxOnCanvas(originalModalBbox, document.getElementById('bboxCanvas'));
            }
            closeOriginalModal();
        }

        window.addEventListener('DOMContentLoaded', function() {
            document.getElementById('openOriginalModalBtn').onclick = function() {
                // ÁèæÂú®ÁîªÂÉè„ÅÆURL„Å®bbox
                const img = document.querySelector('#imageCanvasWrapper img');
                const bbox = images[currentImageIndex] && images[currentImageIndex].bbox ? { ...images[currentImageIndex].bbox } : null;
                if (img) {
                    openOriginalModal(img.src, bbox);
                }
            };
            document.getElementById('closeOriginalModalBtn').onclick = closeOriginalModal;
            document.getElementById('saveOriginalModalBtn').onclick = saveOriginalModalBbox;
        });
        let images = [];
        let currentImageIndex = 0;
        let currentMainLabel = null;
        let currentSubLabels = [];
        let currentDatasetSplit = null;

        // ÂàùÊúüÂåñ
        async function init() {
            try {
                const response = await fetch('/api/images');
                images = await response.json();
                
                if (images.length === 0) {
                    document.getElementById('imageContainer').innerHTML = 
                        '<div class="no-images">images„Éï„Ç©„É´„ÉÄ„Å´ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÈÖçÁΩÆ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
                    return;
                }
                
                document.getElementById('totalImages').textContent = images.length;
                
                // URL„Éë„É©„É°„Éº„Çø„Åã„ÇâÁîªÂÉèID„ÇíÂèñÂæó
                const urlParams = new URLSearchParams(window.location.search);
                const imageId = urlParams.get('imageId');
                
                if (imageId) {
                    // ÊåáÂÆö„Åï„Çå„ÅüÁîªÂÉèID„Å´ÂØæÂøú„Åô„Çã„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÊ§úÁ¥¢
                    const targetIndex = images.findIndex(img => img.id == imageId);
                    if (targetIndex !== -1) {
                        loadImage(targetIndex);
                        // URL„Éë„É©„É°„Éº„Çø„Çí„ÇØ„É™„Ç¢ÔºàÂ±•Ê≠¥„ÇíÊ±ö„Åï„Å™„ÅÑ„Åü„ÇÅÔºâ
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } else {
                        loadImage(0);
                    }
                } else {
                    loadImage(0);
                }
            } catch (error) {
                console.error('ÁîªÂÉè„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
                document.getElementById('imageContainer').innerHTML = 
                    '<div class="no-images">ÁîªÂÉè„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
            }
        }

        // ÁîªÂÉè„ÇíË™≠„ÅøËæº„Åø
        function loadImage(index) {
            if (index < 0 || index >= images.length) return;
            currentImageIndex = index;
            const image = images[index];
            // ÁîªÂÉè„Å®canvas„Çí„É©„ÉÉ„Éë„ÉºÂÜÖ„Å´ÊåøÂÖ•
            const wrapper = document.getElementById('imageCanvasWrapper');
            const cropWrapper = document.getElementById('croppedBoxWrapper');
            const croppedCanvas = document.getElementById('croppedBoxCanvas');
            if (wrapper) {
                const loadingDiv = document.querySelector('#imageContainer .loading');
                if (loadingDiv) loadingDiv.style.display = 'none';
                wrapper.innerHTML = '';
                const img = document.createElement('img');
                img.src = `/images/${image.filename}`;
                img.alt = image.filename;
                img.className = 'image-display';
                img.style.display = 'block';
                img.onload = function() {
                    // ÂÖÉÁîªÂÉè„Çµ„Ç§„Ç∫„ÅßcanvasÁîüÊàê
                    let canvas = document.createElement('canvas');
                    canvas.id = 'bboxCanvas';
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    canvas.style.position = 'absolute';
                    canvas.style.left = '0';
                    canvas.style.top = '0';
                    canvas.style.zIndex = '2';
                    // Ë°®Á§∫„Çµ„Ç§„Ç∫„Çíimg„Å®Âêà„Çè„Åõ„Çã
                    canvas.style.width = '100%';
                    canvas.style.height = '100%';
                    img.style.width = '100%';
                    img.style.height = 'auto';
                    let showCropped = false;
                    let bboxObj = null;
                    if (image.main_label === 'nose') {
                        canvas.style.display = 'block';
                        bboxObj = image.bbox ? (typeof image.bbox === 'string' ? JSON.parse(image.bbox) : image.bbox) : null;
                        drawBboxOnCanvas(bboxObj, canvas);
                        window.currentBbox = bboxObj;
                        images[currentImageIndex].bbox = bboxObj;
                        // bboxÈ†òÂüü„Åè„ÇäÊäú„ÅçË°®Á§∫
                        if (bboxObj && bboxObj.x_min != null && bboxObj.y_min != null && bboxObj.x_max != null && bboxObj.y_max != null) {
                            showCropped = true;
                            // ÂÖÉÁîªÂÉè„ÅÆnatural„Çµ„Ç§„Ç∫Âü∫Ê∫ñ„ÅßÂàá„ÇäÊäú„Åç„ÄÅ2ÂÄçÊã°Â§ßË°®Á§∫
                            const cropW = bboxObj.x_max - bboxObj.x_min;
                            const cropH = bboxObj.y_max - bboxObj.y_min;
                            const scale = 2.0;
                            croppedCanvas.width = cropW * scale;
                            croppedCanvas.height = cropH * scale;
                            croppedCanvas.style.width = (cropW * scale) + 'px';
                            croppedCanvas.style.height = (cropH * scale) + 'px';
                            const ctx = croppedCanvas.getContext('2d');
                            ctx.clearRect(0, 0, cropW * scale, cropH * scale);
                            ctx.drawImage(
                                img,
                                bboxObj.x_min,
                                bboxObj.y_min,
                                cropW,
                                cropH,
                                0, 0, cropW * scale, cropH * scale
                            );
                        }
                    } else {
                        canvas.style.display = 'none';
                        window.currentBbox = null;
                        images[currentImageIndex].bbox = null;
                    }
                    // „É©„ÉÉ„Éë„Éº„Çíposition:relative„Åßimg/canvasÈáç„Å≠„Çã
                    wrapper.style.position = 'relative';
                    wrapper.style.display = 'inline-block';
                    wrapper.appendChild(img);
                    wrapper.appendChild(canvas);
                    // canvas‰∏ä„ÅßbboxÁ∑®ÈõÜ„Åß„Åç„Çã„Çà„ÅÜ„Ç§„Éô„É≥„Éà„Éê„Ç§„É≥„Éâ
                    setupBboxCanvasEvents(canvas, img);
                    // „Åè„ÇäÊäú„ÅçÈ†òÂüü„ÅÆË°®Á§∫ÂàáÊõø
                    if (cropWrapper) cropWrapper.style.display = showCropped ? 'block' : 'none';
                };
            }
        // „Éê„Ç¶„É≥„Éá„Ç£„É≥„Ç∞„Éú„ÉÉ„ÇØ„ÇπÊèèÁîªÈñ¢Êï∞
    window.drawBboxOnCanvas = function drawBboxOnCanvas(bboxJson, canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!bboxJson) return;
            let bbox;
            try {
                bbox = typeof bboxJson === 'string' ? JSON.parse(bboxJson) : bboxJson;
            } catch (e) { return; }
            if (bbox && bbox.x_min != null) {
                ctx.strokeStyle = '#ff0000';
                ctx.lineWidth = 4;
                ctx.strokeRect(
                    bbox.x_min,
                    bbox.y_min,
                    bbox.x_max - bbox.x_min,
                    bbox.y_max - bbox.y_min
                );
                // Ëßí„Éè„É≥„Éâ„É´ÊèèÁîª
                const handleSize = 8;
                const corners = [
                    [bbox.x_min, bbox.y_min],
                    [bbox.x_max, bbox.y_min],
                    [bbox.x_min, bbox.y_max],
                    [bbox.x_max, bbox.y_max]
                ];
                ctx.fillStyle = '#00bfff';
                for (const [cx, cy] of corners) {
                    ctx.fillRect(
                        cx - handleSize/2,
                        cy - handleSize/2,
                        handleSize,
                        handleSize
                    );
                }
            }
        }

        // bboxÊèèÁîª„ÉªÁ∑®ÈõÜÁî®„ÅÆ„Éû„Ç¶„Çπ„Ç§„Éô„É≥„ÉàÔºà„Éâ„É©„ÉÉ„Ç∞„ÅßÊñ∞Ë¶è‰ΩúÊàê/Á∑®ÈõÜÔºâ
        function setupBboxCanvasEvents(canvas, img) {
            // Êó¢Â≠ò„Ç§„Éô„É≥„Éà„ÇíÈô§Âéª
            canvas.onmousedown = null;
            canvas.onmousemove = null;
            canvas.onmouseup = null;
            let isDrawing = false;
            let isMoving = false;
            let isResizing = false;
            let startX = 0, startY = 0;
            let moveOffsetX = 0, moveOffsetY = 0;
            let currentBbox = window.currentBbox || null;
            let originalBbox = null;
            let resizeCorner = null;

            // bboxÂÜÖÂà§ÂÆöÈñ¢Êï∞
            function isInsideBbox(x, y, bbox) {
                if (!bbox) return false;
                let { x_min, y_min, x_max, y_max } = bbox;
                if (x_min > x_max) [x_min, x_max] = [x_max, x_min];
                if (y_min > y_max) [y_min, y_max] = [y_max, y_min];
                return x >= x_min && x <= x_max && y >= y_min && y <= y_max;
            }

            // Ëßí„Éè„É≥„Éâ„É´Âà§ÂÆö
            function getCornerHandle(x, y, bbox, handleSize = 10) {
                if (!bbox) return null;
                let { x_min, y_min, x_max, y_max } = bbox;
                if (x_min > x_max) [x_min, x_max] = [x_max, x_min];
                if (y_min > y_max) [y_min, y_max] = [y_max, y_min];
                const corners = [
                    { name: 'tl', x: x_min, y: y_min }, // Â∑¶‰∏ä
                    { name: 'tr', x: x_max, y: y_min }, // Âè≥‰∏ä
                    { name: 'bl', x: x_min, y: y_max }, // Â∑¶‰∏ã
                    { name: 'br', x: x_max, y: y_max }  // Âè≥‰∏ã
                ];
                for (const corner of corners) {
                    if (Math.abs(x - corner.x) <= handleSize && Math.abs(y - corner.y) <= handleSize) {
                        return corner.name;
                    }
                }
                return null;
            }

            canvas.addEventListener('mousedown', function(e) {
                if (currentMainLabel !== 'nose') return;
                const rect = canvas.getBoundingClientRect();
                startX = (e.clientX - rect.left) * (canvas.width / rect.width);
                startY = (e.clientY - rect.top) * (canvas.height / rect.height);
                // Êó¢Â≠òbboxÂèñÂæó
                let bbox = null;
                if (images[currentImageIndex] && images[currentImageIndex].bbox) {
                    try {
                        bbox = typeof images[currentImageIndex].bbox === 'string' ? JSON.parse(images[currentImageIndex].bbox) : images[currentImageIndex].bbox;
                    } catch {}
                }
                // Ëßí„Éè„É≥„Éâ„É´Âà§ÂÆö
                const corner = bbox ? getCornerHandle(startX, startY, bbox) : null;
                if (bbox && corner) {
                    // „É™„Çµ„Ç§„Ç∫„É¢„Éº„Éâ
                    isResizing = true;
                    resizeCorner = corner;
                    originalBbox = { ...bbox };
                    currentBbox = { ...bbox };
                } else if (bbox && isInsideBbox(startX, startY, bbox)) {
                    // ÁßªÂãï„É¢„Éº„Éâ
                    isMoving = true;
                    originalBbox = { ...bbox };
                    moveOffsetX = startX - bbox.x_min;
                    moveOffsetY = startY - bbox.y_min;
                    currentBbox = { ...bbox };
                } else {
                    // Êñ∞Ë¶è‰ΩúÊàê„É¢„Éº„Éâ
                    isDrawing = true;
                    currentBbox = { x_min: startX, y_min: startY, x_max: startX, y_max: startY };
                }
            });

            canvas.addEventListener('mousemove', function(e) {
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) * (canvas.width / rect.width);
                const y = (e.clientY - rect.top) * (canvas.height / rect.height);
                if (isDrawing) {
                    // Ê≠£ÊñπÂΩ¢Âåñ: „Éâ„É©„ÉÉ„Ç∞ÊñπÂêë„Å´Âøú„Åò„Å¶‰∏ÄËæ∫„ÅÆÈï∑„Åï„ÇíÊ±∫ÂÆö
                    const dx = x - startX;
                    const dy = y - startY;
                    const side = Math.min(Math.abs(dx), Math.abs(dy));
                    let x_max, y_max;
                    if (dx >= 0 && dy >= 0) { // Âè≥‰∏ã
                        x_max = startX + side;
                        y_max = startY + side;
                    } else if (dx < 0 && dy < 0) { // Â∑¶‰∏ä
                        x_max = startX - side;
                        y_max = startY - side;
                    } else if (dx >= 0 && dy < 0) { // Âè≥‰∏ä
                        x_max = startX + side;
                        y_max = startY - side;
                    } else { // Â∑¶‰∏ã
                        x_max = startX - side;
                        y_max = startY + side;
                    }
                    currentBbox.x_max = x_max;
                    currentBbox.y_max = y_max;
                    drawBboxOnCanvas(currentBbox, canvas);
                } else if (isMoving) {
                    // bboxÁßªÂãï
                    const bboxWidth = originalBbox.x_max - originalBbox.x_min;
                    const bboxHeight = originalBbox.y_max - originalBbox.y_min;
                    // Ê≠£ÊñπÂΩ¢„Å™„ÅÆ„Åß‰∏ÄËæ∫
                    const side = Math.min(Math.abs(bboxWidth), Math.abs(bboxHeight));
                    let new_x_min = x - moveOffsetX;
                    let new_y_min = y - moveOffsetY;
                    let new_x_max = new_x_min + side;
                    let new_y_max = new_y_min + side;
                    currentBbox = { x_min: new_x_min, y_min: new_y_min, x_max: new_x_max, y_max: new_y_max };
                    drawBboxOnCanvas(currentBbox, canvas);
                } else if (isResizing) {
                    // „É™„Çµ„Ç§„Ç∫: „Å©„ÅÆËßí„Åß„ÇÇÊ≠£ÊñπÂΩ¢„ÇíÁ∂≠ÊåÅ„Åó„Å§„Å§„Ç∫„É¨„Å™„ÅèÂãï‰Ωú„Åï„Åõ„Çã
                    let { x_min, y_min, x_max, y_max } = originalBbox;
                    let new_x_min = x_min, new_y_min = y_min, new_x_max = x_max, new_y_max = y_max;
                    switch (resizeCorner) {
                        case 'tl': {
                            // Â∑¶‰∏ä„Çí„Éâ„É©„ÉÉ„Ç∞
                            const side = Math.max(x_max - x, y_max - y);
                            new_x_min = x_max - side;
                            new_y_min = y_max - side;
                            break;
                        }
                        case 'tr': {
                            // Âè≥‰∏ä„Çí„Éâ„É©„ÉÉ„Ç∞
                            const side = Math.max(x - x_min, y_max - y);
                            new_x_max = x_min + side;
                            new_y_min = y_max - side;
                            break;
                        }
                        case 'bl': {
                            // Â∑¶‰∏ã„Çí„Éâ„É©„ÉÉ„Ç∞
                            const side = Math.max(x_max - x, y - y_min);
                            new_x_min = x_max - side;
                            new_y_max = y_min + side;
                            break;
                        }
                        case 'br': {
                            // Âè≥‰∏ã„Çí„Éâ„É©„ÉÉ„Ç∞
                            const side = Math.max(x - x_min, y - y_min);
                            new_x_max = x_min + side;
                            new_y_max = y_min + side;
                            break;
                        }
                    }
                    currentBbox = { x_min: new_x_min, y_min: new_y_min, x_max: new_x_max, y_max: new_y_max };
                    drawBboxOnCanvas(currentBbox, canvas);
                }
                window.currentBbox = currentBbox;
            });

            canvas.addEventListener('mouseup', function(e) {
                if (isDrawing) {
                    isDrawing = false;
                    // Êñ∞Ë¶è‰ΩúÊàêÊôÇ„ÅÆ„ÅøÊ≠£ÊñπÂΩ¢Âåñ
                    let { x_min, y_min, x_max, y_max } = currentBbox;
                    if (x_min > x_max) [x_min, x_max] = [x_max, x_min];
                    if (y_min > y_max) [y_min, y_max] = [y_max, y_min];
                    // Ê≠£ÊñπÂΩ¢Âåñ
                    const side = Math.min(x_max - x_min, y_max - y_min);
                    x_max = x_min + side;
                    y_max = y_min + side;
                    currentBbox = { x_min, y_min, x_max, y_max };
                    images[currentImageIndex].bbox = currentBbox;
                    drawBboxOnCanvas(currentBbox, canvas);
                } else if (isMoving) {
                    isMoving = false;
                    // ÁßªÂãïÊôÇ„ÅØ„Åù„ÅÆ„Åæ„Åæ
                    images[currentImageIndex].bbox = { ...currentBbox };
                    drawBboxOnCanvas(currentBbox, canvas);
                } else if (isResizing) {
                    isResizing = false;
                    // „É™„Çµ„Ç§„Ç∫ÊôÇ„ÇÇ„Åù„ÅÆ„Åæ„Åæ
                    images[currentImageIndex].bbox = { ...currentBbox };
                    drawBboxOnCanvas(currentBbox, canvas);
                }
                window.currentBbox = currentBbox;
            });

            // Èºª„ÅÇ„Çä‰ª•Â§ñ„ÅÆÊôÇ„ÅØcanvasÈùûË°®Á§∫
            function updateCanvasVisibility() {
                const image = images[currentImageIndex];
                if (currentMainLabel === 'nose' || (image && image.main_label === 'nose')) {
                    canvas.style.display = 'block';
                } else {
                    canvas.style.display = 'none';
                }
            }
            // „É°„Ç§„É≥„É©„Éô„É´Â§âÊõ¥ÊôÇ„Å´canvasË°®Á§∫„ÇíÂà∂Âæ°
            window.setMainLabel = (function(orig){
                return function(label) {
                    orig(label);
                    updateCanvasVisibility();
                }
            })(window.setMainLabel);
            // ÁîªÂÉèÂàáÊõøÊôÇ„Å´„ÇÇÂèçÊò†
            window.loadImage = (function(orig){
                return function(index) {
                    orig(index);
                    updateCanvasVisibility();
                }
            })(window.loadImage);
        }
            
            // ÁîªÂÉèÊÉÖÂ†±Ë°®Á§∫
            document.getElementById('imageInfo').style.display = 'block';
            document.getElementById('fileName').textContent = image.filename;
            document.getElementById('filePath').textContent = image.filepath;
            document.getElementById('currentLabel').textContent = 
                image.main_label || 'Êú™Ë®≠ÂÆö';

            // bboxÊÉÖÂ†±Ë°®Á§∫
            let bboxObj = image.bbox ? (typeof image.bbox === 'string' ? JSON.parse(image.bbox) : image.bbox) : null;
            if (bboxObj && bboxObj.x_min != null) {
                document.getElementById('bboxInfo').textContent = `x_min: ${bboxObj.x_min}, y_min: ${bboxObj.y_min}, x_max: ${bboxObj.x_max}, y_max: ${bboxObj.y_max}`;
            } else {
                document.getElementById('bboxInfo').textContent = '-';
            }
            // is_completedÊÉÖÂ†±Ë°®Á§∫
            let isCompleted = (image.is_completed === 1 || image.is_completed === true || image.is_completed === '1') ? '‚úîÔ∏è' : '‚úó';
            document.getElementById('isCompletedInfo').textContent = isCompleted;
            
            // „Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÊõ¥Êñ∞
            document.getElementById('currentIndex').textContent = index + 1;
            
            // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('nextBtn').disabled = index === images.length - 1;
            
            // ÁèæÂú®„ÅÆ„É©„Éô„É´Áä∂ÊÖã„ÇíÂæ©ÂÖÉ
            currentMainLabel = image.main_label;
            currentSubLabels = image.sub_labels ? JSON.parse(image.sub_labels) : [];
            currentDatasetSplit = image.dataset_split;
            
            updateUI();
        }

        // UIÁä∂ÊÖã„ÇíÊõ¥Êñ∞
        function updateUI() {
            // „É°„Ç§„É≥„É©„Éô„É´„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
            document.querySelectorAll('.label-button').forEach(btn => {
                btn.classList.remove('active');
            });
            if (currentMainLabel) {
                const activeBtn = document.querySelector(`.label-button.${currentMainLabel}`);
                if (activeBtn) activeBtn.classList.add('active');
            }
            
            // „Çµ„Éñ„É©„Éô„É´„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
            document.querySelectorAll('.sub-label-option').forEach(option => {
                option.classList.remove('active');
                const label = option.getAttribute('data-label');
                if (label && currentSubLabels.includes(label)) {
                    option.classList.add('active');
                }
            });
            
            // „Éá„Éº„Çø„Çª„ÉÉ„ÉàÂàÜÂâ≤„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
            document.querySelectorAll('.split-button').forEach(btn => {
                btn.classList.remove('active');
            });
            if (currentDatasetSplit) {
                const activeBtn = document.querySelector(`.split-button[onclick="setDatasetSplit('${currentDatasetSplit}')"]`);
                if (activeBtn) activeBtn.classList.add('active');
            }
        }

        // „É°„Ç§„É≥„É©„Éô„É´Ë®≠ÂÆöÔºà‰ªªÊÑèÈÅ∏ÊäûÂèØËÉΩÔºâ
        function setMainLabel(label) {
            if (currentMainLabel === label) {
                currentMainLabel = null;
            } else {
                currentMainLabel = label;
            }
            updateUI();
        }

        // „Çµ„Éñ„É©„Éô„É´Âàá„ÇäÊõø„ÅàÔºà„Ç´„ÉÜ„Ç¥„É™ÂÜÖÂçò‰∏ÄÈÅ∏Êäû„Éª„ÇØ„É™„Ç¢ÂèØËÉΩÔºâ
        function toggleSubLabel(label) {
            // „Çµ„Éñ„É©„Éô„É´„ÅÆ„Ç´„ÉÜ„Ç¥„É™ÂÆöÁæ©
            const labelCategories = {
                'front': 'orientation',
                'side': 'orientation', 
                'tilted': 'orientation',
                'clear': 'clarity',
                'blurred': 'clarity',
                'black': 'color',
                'brown': 'color',
                'gray': 'color',
                'pink': 'color',
                'marble': 'color',
                'large': 'nose_size',
                'small': 'nose_size',
                'light_fur': 'fur_color',
                'dark_fur': 'fur_color'
            };
            
            const currentCategory = labelCategories[label];
            
            if (currentCategory) {
                // ÁèæÂú®„ÅÆ„É©„Éô„É´„ÅåÊó¢„Å´ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÂâäÈô§Ôºà„ÇØ„É™„Ç¢Ôºâ
                const currentIndex = currentSubLabels.indexOf(label);
                if (currentIndex > -1) {
                    currentSubLabels.splice(currentIndex, 1);
                } else {
                    // Âêå„Åò„Ç´„ÉÜ„Ç¥„É™„ÅÆ‰ªñ„ÅÆ„É©„Éô„É´„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Å¶„Åã„ÇâÊñ∞„Åó„ÅÑ„É©„Éô„É´„ÇíËøΩÂä†ÔºàÂçò‰∏ÄÈÅ∏ÊäûÔºâ
                    const categoryLabels = Object.keys(labelCategories).filter(
                        key => labelCategories[key] === currentCategory
                    );
                    categoryLabels.forEach(categoryLabel => {
                        const index = currentSubLabels.indexOf(categoryLabel);
                        if (index > -1) {
                            currentSubLabels.splice(index, 1);
                        }
                    });
                    currentSubLabels.push(label);
                }
            }
            
            updateUI();
        }

        // „Éá„Éº„Çø„Çª„ÉÉ„ÉàÂàÜÂâ≤Ë®≠ÂÆö
        function setDatasetSplit(split) {
            currentDatasetSplit = split;
            updateUI();
        }

        // „É©„Éô„É´‰øùÂ≠ò
        async function saveLabel() {
            
            const image = images[currentImageIndex];
            let bbox = window.currentBbox || null;
            const data = {
                image_path: image.filepath,
                main_label: currentMainLabel,
                sub_labels: currentSubLabels,
                dataset_split: currentDatasetSplit,
                bbox: bbox ? JSON.stringify(bbox) : null // „Åì„Åì„Å†„ÅëÊñáÂ≠óÂàóÂåñ
            };
            
            try {
                const response = await fetch('/api/labels', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    // ÁîªÂÉè„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
                    images[currentImageIndex].main_label = currentMainLabel;
                    images[currentImageIndex].sub_labels = JSON.stringify(currentSubLabels);
                    images[currentImageIndex].dataset_split = currentDatasetSplit;
                    images[currentImageIndex].is_completed = 1;
                    // ÁèæÂú®„ÅÆ„É©„Éô„É´Ë°®Á§∫„ÇíÊõ¥Êñ∞
                    document.getElementById('currentLabel').textContent = currentMainLabel;
                    document.getElementById('isCompletedInfo').textContent = '‚úîÔ∏è';
                    // Ê¨°„ÅÆÁîªÂÉè„Å´ÁßªÂãï
                    if (currentImageIndex < images.length - 1) {
                        nextImage();
                    }
                } else {
                    alert('„É©„Éô„É´„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                console.error('‰øùÂ≠ò„Ç®„É©„Éº:', error);
                alert('„É©„Éô„É´„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        // Ââç„ÅÆÁîªÂÉè
        function previousImage() {
            if (currentImageIndex > 0) {
                loadImage(currentImageIndex - 1);
            }
        }

        // Ê¨°„ÅÆÁîªÂÉè
        function nextImage() {
            if (currentImageIndex < images.length - 1) {
                loadImage(currentImageIndex + 1);
            }
        }



        // „Éá„Éº„Çø„Çª„ÉÉ„Éà„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        function exportDataset() {
            window.open('/api/export/dataset', '_blank');
        }

        // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
        document.addEventListener('keydown', function(event) {
            // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Å´„Éï„Ç©„Éº„Ç´„Çπ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÁÑ°Ë¶ñ
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return;
            }
            
            switch(event.key) {
                case '1':
                    setMainLabel('nose');
                    break;
                case 'f':
                case 'F':
                    toggleSubLabel('front');
                    break;
                case 's':
                case 'S':
                    toggleSubLabel('side');
                    break;
                case 't':
                case 'T':
                    toggleSubLabel('tilted');
                    break;
                case 'c':
                case 'C':
                    toggleSubLabel('clear');
                    break;
                case 'b':
                case 'B':
                    toggleSubLabel('blurred');
                    break;
                case 'k':
                case 'K':
                    toggleSubLabel('black');
                    break;
                case 'r':
                case 'R':
                    toggleSubLabel('brown');
                    break;
                case 'p':
                case 'P':
                    toggleSubLabel('pink');
                    break;
                case 'g':
                case 'G':
                    toggleSubLabel('gray');
                    break;
                case 'm':
                case 'M':
                    toggleSubLabel('marble');
                    break;
                case 'l':
                case 'L':
                    toggleSubLabel('large');
                    break;
                case 'q':
                case 'Q':
                    toggleSubLabel('small');
                    break;
                case 'j':
                case 'J':
                    toggleSubLabel('light_fur');
                    break;
                case 'n':
                case 'N':
                    toggleSubLabel('dark_fur');
                    break;
                case 'ArrowLeft':
                    previousImage();
                    break;
                case 'ArrowRight':
                    nextImage();
                    break;
                case 'Enter':
                    saveLabel();
                    break;
            }
        });


        async function previewAutoSplit() {
            const trainPercent = parseFloat(document.getElementById('trainPercent').value);
            const valPercent = parseFloat(document.getElementById('valPercent').value);
            const testPercent = parseFloat(document.getElementById('testPercent').value);
            
            const total = trainPercent + valPercent + testPercent;
            if (Math.abs(total - 100) > 0.01) {
                alert(`Ââ≤Âêà„ÅÆÂêàË®à„Åå100%„Å´„Å™„Çä„Åæ„Åõ„Çì: ${total}%`);
                return;
            }
            
            if (trainPercent < 0 || valPercent < 0 || testPercent < 0) {
                alert('Ââ≤Âêà„ÅØ0‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const requestData = {
                train_percent: trainPercent,
                val_percent: valPercent,
                test_percent: testPercent,
                preview_only: true
            };
            
            const button = document.querySelector('.preview-button');
            const originalText = button.textContent;
            button.textContent = '„Éó„É¨„Éì„É•„Éº‰∏≠...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/auto-split', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    displayPreviewResult(result);
                } else {
                    alert(result.error || '„Éó„É¨„Éì„É•„Éº„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                console.error('„Éó„É¨„Éì„É•„Éº„Ç®„É©„Éº:', error);
                alert('„Éó„É¨„Éì„É•„Éº„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        function displayPreviewResult(result) {
            const previewDiv = document.getElementById('splitPreview');
            
            previewDiv.innerHTML = `
                <h4>üìä ÂàÜÂâ≤„Éó„É¨„Éì„É•„Éº</h4>
                <p>„É°„Ç§„É≥„É©„Éô„É´Ë®≠ÂÆöÊ∏à„ÅøÁîªÂÉè: <strong>${result.total_images}Êûö</strong></p>
                <div class="preview-stats">
                    <div class="stat-item">
                        <div class="stat-value">${result.train_count}Êûö</div>
                        <div class="stat-label">Train (${result.train_percent_actual}%)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${result.val_count}Êûö</div>
                        <div class="stat-label">Val (${result.val_percent_actual}%)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${result.test_count}Êûö</div>
                        <div class="stat-label">Test (${result.test_percent_actual}%)</div>
                    </div>
                </div>
                <p style="margin-top: 15px; color: #666; font-size: 14px;">
                    ‚ö†Ô∏è ÂÆüË°å„Åô„Çã„Å®Êó¢Â≠ò„ÅÆÂàÜÂâ≤Ë®≠ÂÆö„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô
                </p>
            `;
            
            previewDiv.style.display = 'block';
            document.getElementById('splitResult').style.display = 'none';
        }
        
        async function executeAutoSplit() {
            const trainPercent = parseFloat(document.getElementById('trainPercent').value);
            const valPercent = parseFloat(document.getElementById('valPercent').value);
            const testPercent = parseFloat(document.getElementById('testPercent').value);
            
            const total = trainPercent + valPercent + testPercent;
            if (Math.abs(total - 100) > 0.01) {
                alert(`Ââ≤Âêà„ÅÆÂêàË®à„Åå100%„Å´„Å™„Çä„Åæ„Åõ„Çì: ${total}%`);
                return;
            }
            
            if (trainPercent < 0 || valPercent < 0 || testPercent < 0) {
                alert('Ââ≤Âêà„ÅØ0‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const requestData = {
                train_percent: trainPercent,
                val_percent: valPercent,
                test_percent: testPercent,
                overwrite_existing: true
            };
            const confirmMessage = `„É°„Ç§„É≥„É©„Éô„É´Ë®≠ÂÆöÊ∏à„Åø„ÅÆÂÖ®„Å¶„ÅÆÁîªÂÉè„Çí‰ª•‰∏ã„ÅÆÂâ≤Âêà„ÅßÂàÜÂâ≤„Åó„Åæ„Åô:\nTrain: ${trainPercent}%\nVal: ${valPercent}%\nTest: ${testPercent}%\n\nÊó¢Â≠ò„ÅÆÂàÜÂâ≤Ë®≠ÂÆö„ÇÇ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            const button = document.querySelector('.auto-split-button');
            const originalText = button.textContent;
            button.textContent = 'ÂàÜÂâ≤‰∏≠...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/auto-split', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    displayExecuteResult(result);
                    
                    if (images.length > 0) {
                        const response = await fetch('/api/images');
                        images = await response.json();
                        loadImage(currentImageIndex);
                    }
                } else {
                    alert(result.error || 'Ëá™ÂãïÂàÜÂâ≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                console.error('Ëá™ÂãïÂàÜÂâ≤„Ç®„É©„Éº:', error);
                alert('Ëá™ÂãïÂàÜÂâ≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        function displayExecuteResult(result) {
            const resultDiv = document.getElementById('splitResult');
            
            resultDiv.innerHTML = `
                <h4>‚úÖ Ëá™ÂãïÂàÜÂâ≤ÂÆå‰∫Ü</h4>
                <p>${result.message}</p>
                <div class="preview-stats">
                    <div class="stat-item">
                        <div class="stat-value">${result.train_count}Êûö</div>
                        <div class="stat-label">Train (${result.train_percent_actual}%)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${result.val_count}Êûö</div>
                        <div class="stat-label">Val (${result.val_percent_actual}%)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${result.test_count}Êûö</div>
                        <div class="stat-label">Test (${result.test_percent_actual}%)</div>
                    </div>
                </div>
                <p style="margin-top: 15px; color: #4CAF50; font-weight: bold;">
                    üîç „É¨„Éì„É•„ÉºÁîªÈù¢„ÅßÁµêÊûú„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô
                </p>
            `;
            
            resultDiv.style.display = 'block';
            document.getElementById('splitPreview').style.display = 'none';
        }

        // ÂàùÊúüÂåñÂÆüË°å
        init();
    </script>
</body>
</html>
