<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ | çŠ¬ã®é¼»ãƒ©ãƒ™ãƒªãƒ³ã‚°ç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
	<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
			padding-top: 80px; /* ãƒ˜ãƒƒãƒ€ãƒ¼åˆ†ã®ä½™ç™½ */
		}
		.header {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 20px;
			border-radius: 10px;
			margin-bottom: 20px;
			text-align: center;
		}
		.header h1 {
			font-size: 2.5em;
			margin-bottom: 10px;
		}
		.header p {
			font-size: 1.1em;
			opacity: 0.9;
		}
        .auto-split-section {
			margin: 40px 0 0 0;
			padding: 24px;
			border: 2px solid #4CAF50;
			border-radius: 8px;
			background-color: #f9f9f9;
			max-width: 500px;
			margin-left: auto;
			margin-right: auto;
		}
		.percentage-inputs {
			display: flex;
			gap: 15px;
			margin-bottom: 15px;
			flex-wrap: wrap;
		}
		.input-group {
			display: flex;
			flex-direction: column;
			min-width: 100px;
		}
		.input-group label {
			font-weight: bold;
			margin-bottom: 5px;
			color: #333;
		}
		.input-group input {
			padding: 8px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 14px;
		}
		.auto-split-buttons {
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
			margin-top: 12px; /* ä¸Šã«ä½™ç™½ã‚’è¿½åŠ  */
		}
		.preview-button, .auto-split-button {
			padding: 10px 20px;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			margin-top: 8px; /* å„ãƒœã‚¿ãƒ³å€‹åˆ¥ã«ã‚‚ä¸Šä½™ç™½ã‚’ä»˜ä¸ */
		}
		.preview-button { background-color: #2196F3; color: white; }
		.preview-button:hover { background-color: #1976D2; }
		.auto-split-button { background-color: #4CAF50; color: white; }
		.auto-split-button:hover { background-color: #45a049; }

		.split-preview {
			margin-top: 15px;
			padding: 15px;
			border-radius: 5px;
			background-color: white;
			border-left: 4px solid #2196F3;
		}
		.split-result {
			margin-top: 15px;
			padding: 15px;
			border-radius: 5px;
			background-color: white;
			border-left: 4px solid #4CAF50;
		}
		.preview-stats {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
			gap: 10px;
			margin-top: 10px;
		}
		.table-wrap { overflow-x: auto; margin-top: 10px; }
		.preview-table { width: 100%; border-collapse: collapse; }
		.preview-table caption { text-align: left; font-weight: 600; margin-bottom: 6px; }
		.preview-table th, .preview-table td { border: 1px solid #ddd; padding: 6px 8px; text-align: center; font-size: 13px; }
		/* è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ—å¹…ã‚’å›ºå®šã—ã¦æƒãˆã‚‹ */
		.details-table { table-layout: fixed; width: 100%; }
		.details-table .col-value { width: 30%; }
		.details-table .col-split { width: 23.333%; }
		.details-table th:first-child, .details-table td:first-child { text-align: left; }
		.cell-ok { background: #e8f5e9; color: #2e7d32; font-weight: 600; }
		.cell-need { background: #fff3e0; color: #ef6c00; font-weight: 600; }
		.cell-extra { background: #e3f2fd; color: #1565c0; font-weight: 600; }
		.cell-muted { color: #999; }
	</style>
</head>
<body>
	{% include 'header.html' with context %}
	<div class="container" style="padding-top:80px;">
		<!-- è‡ªå‹•ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆåˆ†å‰²ï¼ˆæ¯”ç‡å…¥åŠ›ï¼‰ -->
		<div class="auto-split-section">
			<h2 style="margin-bottom: 12px;">ğŸ¯ è‡ªå‹•ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆåˆ†å‰²</h2>
			<div class="percentage-inputs">
				<div class="input-group">
					<label for="trainPercent">Train (%)</label>
					<input type="number" id="trainPercent" min="0" max="100" step="0.1" value="80">
				</div>
				<div class="input-group">
					<label for="valPercent">Val (%)</label>
					<input type="number" id="valPercent" min="0" max="100" step="0.1" value="10">
				</div>
				<div class="input-group">
					<label for="testPercent">Test (%)</label>
					<input type="number" id="testPercent" min="0" max="100" step="0.1" value="10">
				</div>
			</div>
			<div id="splitEstimate" style="margin-top:8px; font-size:13px; color:#333; background:#fff; border:1px dashed #ccc; border-radius:6px; padding:8px; display:none;">
				<div>å¯¾è±¡æšæ•°: <strong id="eligibleTotal">-</strong> æš</div>
				<div style="margin-top:6px; display:flex; gap:12px; flex-wrap:wrap;">
					<span>Train æ¨å®š: <strong id="estTrain">-</strong> æš</span>
					<span>Val æ¨å®š: <strong id="estVal">-</strong> æš</span>
					<span>Test æ¨å®š: <strong id="estTest">-</strong> æš</span>
				</div>
			</div>
		</div>

		<!-- è©³ç´°ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®è¨­å®š -->
				<div style="margin-top:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:12px;">
					<h4 style="margin-bottom:8px;">âš™ï¸ è©³ç´°ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼ˆä»»æ„ï¼‰</h4>
					<p style="font-size:12px; color:#666; margin-bottom:8px;">å„Splitã«å«ã‚ãŸã„å‰²åˆ(%)ã‚’å±æ€§ã”ã¨ã«è¨­å®šã§ãã¾ã™ã€‚æœªå…¥åŠ›ã¯ç„¡è¦–ã•ã‚Œã¾ã™ã€‚</p>
					<div id="targetControls" style="display:grid; grid-template-columns: 1fr; gap:10px;">
						<!-- ã‚¯ãƒ©ã‚¹ï¼ˆé¼»ã‚ã‚Š/é¼»ãªã—ï¼‰ -->
						<div>
							<div style="font-weight:600; margin-bottom:6px;">ã‚¯ãƒ©ã‚¹</div>
							<div style="display:grid; grid-template-columns: auto 1fr; gap:8px; align-items:center;">
								<label>é¼»ã‚ã‚Š</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_main_label_nose_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_main_label_nose_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_main_label_nose_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
								<label>é¼»ãªã—</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_main_label_none_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_main_label_none_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_main_label_none_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
							</div>
						</div>
						<!-- å‘ã -->
						<div>
							<div style="font-weight:600; margin-bottom:6px;">å‘ã</div>
							<div style="display:grid; grid-template-columns: auto 1fr; gap:8px; align-items:center;">
								<label>æ­£é¢</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_orientation_front_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_orientation_front_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_orientation_front_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
								<label>æ¨ªå‘ã</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_orientation_side_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_orientation_side_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_orientation_side_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
								<label>æ–œã‚</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_orientation_tilted_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_orientation_tilted_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_orientation_tilted_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
							</div>
						</div>
						<!-- é®®æ˜åˆ¤å®š -->
						<div>
							<div style="font-weight:600; margin-bottom:6px;">é®®æ˜åˆ¤å®š</div>
							<div style="display:grid; grid-template-columns: auto 1fr; gap:8px; align-items:center;">
								<label>é®®æ˜</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_clarity_clear_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_clarity_clear_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_clarity_clear_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
								<label>ã¼ã‚„ã‘</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_clarity_blurred_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_clarity_blurred_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_clarity_blurred_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
							</div>
						</div>
						<!-- é¼»ã®è‰² -->
						<div>
							<div style="font-weight:600; margin-bottom:6px;">é¼»ã®è‰²</div>
							<div style="display:grid; grid-template-columns: auto 1fr; gap:8px; align-items:center;">
								<label>é»’</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_color_black_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_color_black_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_color_black_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
								<label>èŒ¶è‰²</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_color_brown_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_color_brown_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_color_brown_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
								<label>ç°è‰²</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_color_gray_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_color_gray_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_color_gray_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
								<label>ãƒ”ãƒ³ã‚¯</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_color_pink_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_color_pink_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_color_pink_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>

								<label>ãƒãƒ¼ãƒ–ãƒ«</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_color_marble_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_color_marble_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_color_marble_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
							</div>
						</div>
						<!-- ä»–ã®å±æ€§ï¼ˆå¤§ãã•ãƒ»æ¯›è‰²ãƒ»é¼»ã®é•·ã•ï¼‰ã¯çœç•¥ã›ãšåŒæ§˜ã«å®šç¾© -->
						<div>
							<div style="font-weight:600; margin-bottom:6px;">é¼»ã®å¤§ãã•</div>
							<div style="display:grid; grid-template-columns: auto 1fr; gap:8px; align-items:center;">
								<label>å¤§ãã„</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_size_large_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_size_large_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_size_large_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
								<label>å°ã•ã„</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_size_small_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_size_small_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_size_small_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
							</div>
						</div>
						<div>
							<div style="font-weight:600; margin-bottom:6px;">æ¯›è‰²</div>
							<div style="display:grid; grid-template-columns: auto 1fr; gap:8px; align-items:center;">
								<label>æ˜ã‚‹ã„æ¯›è‰²</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_fur_light_fur_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_fur_light_fur_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_fur_light_fur_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
								<label>æš—ã„æ¯›è‰²</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_fur_dark_fur_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_fur_dark_fur_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_fur_dark_fur_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
							</div>
						</div>
						<div>
							<div style="font-weight:600; margin-bottom:6px;">é¼»ã®é•·ã•</div>
							<div style="display:grid; grid-template-columns: auto 1fr; gap:8px; align-items:center;">
								<label>é•·ã„</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_nose_length_nose_long_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_nose_length_nose_long_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_nose_length_nose_long_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
								<label>ä¸­</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_nose_length_nose_medium_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_nose_length_nose_medium_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_nose_length_nose_medium_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
								<label>çŸ­ã„</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_nose_length_nose_short_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_nose_length_nose_short_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_nose_length_nose_short_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
							</div>
						</div>
					</div>
					<!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼/å®Ÿè¡Œãƒœã‚¿ãƒ³ï¼ˆè©³ç´°ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç›´ä¸‹ï¼‰ -->
					<div class="auto-split-buttons" style="margin-top: 16px;">
						<div style="display:flex; flex-direction:column; gap:6px; margin-bottom:8px; font-size:13px;">
							<label style="display:flex; align-items:center; gap:8px;">
								<input type="checkbox" id="preferTargetDistribution">
								<span>æŒ‡å®šã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’é‡è¦–ã—ã¦é…åˆ†ï¼ˆæ¯”ç‡ã¯è¿‘ä¼¼ï¼‰</span>
							</label>
						</div>
						<button class="preview-button" onclick="previewAutoSplit()">ğŸ“Š ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
						<button class="auto-split-button" onclick="executeAutoSplit()">ğŸ¯ è‡ªå‹•åˆ†å‰²å®Ÿè¡Œ</button>
					</div>
				</div>
			</div>
			<div id="splitPreview" class="split-preview" style="display: none;"></div>
			<div id="splitResult" class="split-result" style="display: none;"></div>
			<!-- è¡¨è¨˜/è‰²ã®ãƒ«ãƒ¼ãƒ«ï¼ˆå°ã•ãè¡¨ç¤ºï¼‰ -->
			<div id="notationLegend" style="margin-top:10px; font-size:12px; color:#666; background:#fff; border:1px dashed #ddd; border-radius:6px; padding:10px;">
				<div style="font-weight:600; margin-bottom:4px;">è¡¨è¨˜ãƒ«ãƒ¼ãƒ«</div>
				<ul style="margin-left:18px;">
					<li>è¡¨è¨˜ï¼ˆä¾‹: <strong>40/25</strong>ï¼‰</li>
					<li>å·¦å´ï¼ˆ40ï¼‰: å®Ÿç¸¾æšæ•° = ãã®Splitã«å®Ÿéš›ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸæšæ•°</li>
					<li>å³å´ï¼ˆ25ï¼‰: ç›®æ¨™æšæ•° = å…¥åŠ›ã—ãŸå‰²åˆ(%)ã‹ã‚‰ç®—å‡ºã—ãŸè¦æ±‚æšæ•°</li>
					<li>ç®—å‡ºã¯ã€Œãã®Splitã®ç›®æ¨™åˆè¨ˆæšæ•° Ã— æŒ‡å®šå‰²åˆ(%) / 100ã€ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€ç«¯æ•°ã¯ãƒãƒŸãƒ«ãƒˆãƒ³æ³•ã§æŒ‰åˆ†</li>
				</ul>
				<div style="font-weight:600; margin:8px 0 4px;">è‰²ã®ãƒ«ãƒ¼ãƒ«</div>
				<ul style="margin-left:18px;">
					<li>ç·‘: å®Ÿç¸¾ãŒç›®æ¨™ä»¥ä¸Šï¼ˆé”æˆï¼‰</li>
					<li>ã‚ªãƒ¬ãƒ³ã‚¸: ç›®æ¨™ &gt; 0 ã‹ã¤ å®Ÿç¸¾ &lt; ç›®æ¨™ï¼ˆä¸è¶³ï¼‰</li>
					<li>é’: ç›®æ¨™ = 0 ã ãŒ å®Ÿç¸¾ &gt; 0ï¼ˆæŒ‡å®šå¤–ã ãŒå«ã¾ã‚Œã‚‹ï¼‰</li>
					<li>ã‚°ãƒ¬ãƒ¼: ç›®æ¨™ = 0 ã‹ã¤ å®Ÿç¸¾ = 0ï¼ˆå¯¾è±¡ãªã—ï¼‰</li>
				</ul>
			</div>
		</div>
		<div class="export-section" style="max-width:500px; margin:40px auto 0; background:#fff; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.07); padding:32px 24px;">
			<h2 style="text-align:center; margin-bottom:24px;">ğŸ“ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h2>
			<div class="export-buttons" style="display:grid; grid-template-columns:1fr; gap:16px;">
				<button class="dataset-export" style="padding:16px; font-size:16px; background:#17a2b8; color:#fff; border:none; border-radius:6px; cursor:pointer;" onclick="exportDataset()">ğŸ“ ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆZIPå‡ºåŠ›</button>
			</div>
			<div style="margin-top:24px; text-align:center; color:#888; font-size:13px;">â€»ã€Œã“ã®ç”»åƒã ã‘ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆZIPã€ã¯ãƒ©ãƒ™ãƒªãƒ³ã‚°ç”»é¢ã§ã®ã¿æœ‰åŠ¹ã§ã™</div>
		</div>
		<script>
		// ==========================
		// å®šæ•°ãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
		// ==========================
		const SPLITS = ['train', 'val', 'test'];
		const ATTRIBUTE_KEYS = ['main_label','orientation','clarity','color','size','fur','nose_length'];
		const VALUE_KEYS_BY_ATTR = {
			main_label: ['nose','none'],
			orientation: ['front','side','tilted'],
			clarity: ['clear','blurred'],
			color: ['black','brown','gray','pink','marble'],
			size: ['large','small'],
			fur: ['light_fur','dark_fur'],
			nose_length: ['nose_long','nose_medium','nose_short']
		};
		const DEFAULT_TRAIN = 80;
		const DEFAULT_VAL = 10;
		const DEFAULT_TEST = 10;
		const PERCENT_TOTAL = 100;
		const FLOAT_TOLERANCE = 0.01;
		const ATTR_LABELS_JA = {
			orientation: 'å‘ã',
			clarity: 'é®®æ˜åˆ¤å®š',
			color: 'é¼»ã®è‰²',
			size: 'é¼»ã®å¤§ãã•',
			fur: 'æ¯›è‰²',
			nose_length: 'é¼»ã®é•·ã•',
			main_label: 'ã‚¯ãƒ©ã‚¹'
		};
		const VALUE_LABELS_JA = {
			front: 'æ­£é¢', side: 'æ¨ªå‘ã', tilted: 'æ–œã‚',
			clear: 'é®®æ˜', blurred: 'ã¼ã‚„ã‘',
			black: 'é»’', brown: 'èŒ¶è‰²', gray: 'ç°è‰²', pink: 'ãƒ”ãƒ³ã‚¯', marble: 'ãƒãƒ¼ãƒ–ãƒ«',
			large: 'å¤§ãã„', small: 'å°ã•ã„',
			light_fur: 'æ˜ã‚‹ã„æ¯›è‰²', dark_fur: 'æš—ã„æ¯›è‰²',
			nose_long: 'é•·ã„', nose_medium: 'ä¸­', nose_short: 'çŸ­ã„',
			nose: 'é¼»ã‚ã‚Š', none: 'é¼»ãªã—'
		};
		function translateLabel(map, key) { return map[key] || key; }
		function qs(sel) { return document.querySelector(sel); }
		function setInputValueIfExists(id, value) { const el = document.getElementById(id); if (el) el.value = value; }
		function getNumberInputValue(id) { const el = document.getElementById(id); return el ? parseFloat(el.value) : NaN; }

		// æ¨å®šç”¨ã®çŠ¶æ…‹
		let eligibleCount = null; // is_completed==1 ã®æšæ•°

		// ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
		function exportDataset() { window.open('/api/export/dataset', '_blank'); }
		function exportCurrentImageDataset() { alert('ã€Œã“ã®ç”»åƒã ã‘ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆZIPã€ã¯ãƒ©ãƒ™ãƒªãƒ³ã‚°ç”»é¢ã§ã”åˆ©ç”¨ãã ã•ã„ã€‚'); }

		// DBã®æœ€æ–°è¨­å®šã‚’UIã¸åæ˜ 
		function applyTargetsToUI(targets) {
			if (!targets) return;
			Object.keys(targets).forEach(attr => {
				const vals = targets[attr] || {};
				Object.keys(vals).forEach(val => {
					SPLITS.forEach(s => {
						const v = vals[val] && vals[val][s];
						if (v === undefined || v === null) return;
						setInputValueIfExists(`t_${attr}_${val}_${s}`, v);
					});
				});
			});
		}
		async function loadSavedAutoSplitSettings() {
			try {
				const res = await fetch('/api/auto-split/settings');
				if (!res.ok) return;
				const conf = await res.json();
				setInputValueIfExists('trainPercent', conf.train_percent ?? DEFAULT_TRAIN);
				setInputValueIfExists('valPercent', conf.val_percent ?? DEFAULT_VAL);
				setInputValueIfExists('testPercent', conf.test_percent ?? DEFAULT_TEST);
				applyTargetsToUI(conf.targets || {});
			} catch (e) {
				console.warn('è¨­å®šèª­è¾¼ã«å¤±æ•—:', e);
			}
		}

		// æ¨å®šè¨ˆç®—
		function computeAndRenderEstimate() {
			const wrap = document.getElementById('splitEstimate');
			if (eligibleCount === null) { wrap.style.display = 'none'; return; }
			const train = getNumberInputValue('trainPercent');
			const val = getNumberInputValue('valPercent');
			const test = getNumberInputValue('testPercent');
			if ([train,val,test].some(v => Number.isNaN(v))) { wrap.style.display = 'none'; return; }
			const totalPct = train + val + test;
			if (Math.abs(totalPct - 100) > FLOAT_TOLERANCE || train < 0 || val < 0 || test < 0) { wrap.style.display = 'none'; return; }

			// ãƒãƒŸãƒ«ãƒˆãƒ³æ³•ã§åˆè¨ˆãŒä¸€è‡´ã™ã‚‹æ¨å®šæšæ•°
			const exact = { train: eligibleCount * train / 100, val: eligibleCount * val / 100, test: eligibleCount * test / 100 };
			const base = { train: Math.floor(exact.train), val: Math.floor(exact.val), test: Math.floor(exact.test) };
			let assigned = base.train + base.val + base.test;
			const remainders = [ ['train', exact.train - base.train], ['val', exact.val - base.val], ['test', exact.test - base.test] ].sort((a,b) => b[1]-a[1]);
			let i = 0;
			while (assigned < eligibleCount) { const s = remainders[i % remainders.length][0]; base[s] += 1; assigned += 1; i++; }

			document.getElementById('eligibleTotal').textContent = eligibleCount;
			document.getElementById('estTrain').textContent = base.train;
			document.getElementById('estVal').textContent = base.val;
			document.getElementById('estTest').textContent = base.test;
			wrap.style.display = 'block';
		}

        // ã‚µãƒãƒªãƒ¼ã‚’åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã§è¨ˆç®—
        function computeCountsByHamilton(total, train, val, test) {
            const exact = { train: total * train / 100, val: total * val / 100, test: total * test / 100 };
            const base = { train: Math.floor(exact.train), val: Math.floor(exact.val), test: Math.floor(exact.test) };
            let assigned = base.train + base.val + base.test;
            const rema = [ ['train', exact.train - base.train], ['val', exact.val - base.val], ['test', exact.test - base.test] ].sort((a,b) => b[1]-a[1]);
            let i = 0;
            while (assigned < total) { const s = rema[i % rema.length][0]; base[s] += 1; assigned += 1; i++; }
            return base;
        }

	async function loadEligibleCount() {
			try {
				const res = await fetch('/api/images');
				const list = await res.json();
		// å¯¾è±¡: is_completed ãŒçœŸã®ã‚‚ã®ï¼ˆ1, '1', true, 'true'ï¼‰
		const toBool = v => v === 1 || v === '1' || v === true || v === 'true';
		eligibleCount = (list || []).filter(x => toBool(x.is_completed)).length;
			} catch (e) {
				console.warn('å¯¾è±¡æšæ•°ã®å–å¾—ã«å¤±æ•—:', e);
				eligibleCount = null;
			} finally {
				computeAndRenderEstimate();
			}
		}

		function wireEstimateEvents() {
			['trainPercent','valPercent','testPercent'].forEach(id => {
				const el = document.getElementById(id);
				if (el) el.addEventListener('input', computeAndRenderEstimate);
			});
		}

		// å…¥åŠ›åé›†ãƒ»æ¤œè¨¼
		function collectTargets() {
			const targets = {};
			ATTRIBUTE_KEYS.forEach(attr => {
				const values = VALUE_KEYS_BY_ATTR[attr];
				const perAttr = {};
				values.forEach(val => {
					let hasAny = false;
					const perSplit = {};
					SPLITS.forEach(s => {
						const el = document.getElementById(`t_${attr}_${val}_${s}`);
						if (el && el.value !== '') {
							perSplit[s] = parseFloat(el.value);
							hasAny = true;
						}
					});
					if (hasAny) perAttr[val] = perSplit;
				});
				if (Object.keys(perAttr).length > 0) targets[attr] = perAttr;
			});
			return targets;
		}
		function getSplitPercents() { return { train: getNumberInputValue('trainPercent'), val: getNumberInputValue('valPercent'), test: getNumberInputValue('testPercent') }; }
		function validateSplitPercents({ train, val, test }) {
			const total = train + val + test;
			if (Math.abs(total - PERCENT_TOTAL) > FLOAT_TOLERANCE) { alert(`å‰²åˆã®åˆè¨ˆãŒ100%ã«ãªã‚Šã¾ã›ã‚“: ${total}%`); return false; }
			if (train < 0 || val < 0 || test < 0) { alert('å‰²åˆã¯0ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„'); return false; }
			return true;
		}
		function buildAutoSplitRequest({ previewOnly, includeOverwriteFlag }) {
			const { train, val, test } = getSplitPercents();
			const body = { train_percent: train, val_percent: val, test_percent: test, preview_only: !!previewOnly, targets: collectTargets(),
				prefer_target_distribution: !!document.getElementById('preferTargetDistribution')?.checked };
			if (includeOverwriteFlag) body.overwrite_existing = true; // å¾Œæ–¹äº’æ›
			return body;
		}
	async function runAutoSplit({ buttonSelector, loadingText, requestBody, onSuccess, onErrorMessage }) {
			const button = qs(buttonSelector);
			const originalText = button.textContent;
			button.textContent = loadingText;
			button.disabled = true;
			try {
		const response = await fetch('/api/auto-split', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
		let result;
		const text = await response.text();
		try { result = text ? JSON.parse(text) : {}; } catch (_) { result = { error: text || null }; }
		if (response.ok) onSuccess(result); else alert(result && result.error ? result.error : (onErrorMessage + (result && result.error ? `: ${result.error}` : '')));
			} catch (error) {
				console.error(onErrorMessage, error); alert(onErrorMessage);
			} finally { button.textContent = originalText; button.disabled = false; }
		}

		// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼/å®Ÿè¡Œ
		async function previewAutoSplit() {
			const percents = getSplitPercents(); if (!validateSplitPercents(percents)) return;
			const requestData = buildAutoSplitRequest({ previewOnly: true, includeOverwriteFlag: false });
			await runAutoSplit({ buttonSelector: '.preview-button', loadingText: 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­...', requestBody: requestData, onSuccess: displayPreviewResult, onErrorMessage: 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' });
		}
		async function executeAutoSplit() {
			const percents = getSplitPercents(); if (!validateSplitPercents(percents)) return;
			const { train, val, test } = percents;
			const confirmMessage = `ã‚¯ãƒ©ã‚¹è¨­å®šæ¸ˆã¿ã®å…¨ã¦ã®ç”»åƒã‚’ä»¥ä¸‹ã®å‰²åˆã§åˆ†å‰²ã—ã¾ã™:\nTrain: ${train}%\nVal: ${val}%\nTest: ${test}%\n\næ—¢å­˜ã®åˆ†å‰²è¨­å®šã‚‚ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ`;
			if (!confirm(confirmMessage)) return;
			const requestData = buildAutoSplitRequest({ previewOnly: false, includeOverwriteFlag: true });
			await runAutoSplit({ buttonSelector: '.auto-split-button', loadingText: 'åˆ†å‰²ä¸­...', requestBody: requestData, onSuccess: displayExecuteResult, onErrorMessage: 'è‡ªå‹•åˆ†å‰²ã«å¤±æ•—ã—ã¾ã—ãŸ' });
		}
		function renderSummaryTableFromCounts(total, counts) {
			const rows = [
				{ key: 'TRAIN', count: counts.train, percent: total ? Math.round(counts.train / total * 1000)/10 : 0 },
				{ key: 'VAL', count: counts.val, percent: total ? Math.round(counts.val / total * 1000)/10 : 0 },
				{ key: 'TEST', count: counts.test, percent: total ? Math.round(counts.test / total * 1000)/10 : 0 }
			];
			return `<div class="table-wrap"><table class="preview-table"><caption>åˆ†å‰²ã‚µãƒãƒªãƒ¼</caption><thead><tr><th>Split</th><th>æšæ•°</th><th>å‰²åˆ</th></tr></thead><tbody>${rows.map(r => `<tr><td>${r.key}</td><td>${r.count}æš</td><td>${r.percent}%</td></tr>`).join('')}</tbody></table></div>`;
		}
		function renderDetailsTables(details) {
			if (!details) return '';
			const splitOrder = SPLITS; const attrOrder = ['orientation','clarity','color','size','fur','nose_length','main_label'];
			let html = ''; const pivot = {};
			splitOrder.forEach(split => {
				const attrs = details[split] || {};
				Object.keys(attrs).forEach(attr => {
					pivot[attr] = pivot[attr] || {};
					const reqs = (attrs[attr] && attrs[attr].required_counts) || {};
					const acts = (attrs[attr] && attrs[attr].actual_counts) || {};
					const vals = new Set([...Object.keys(reqs), ...Object.keys(acts)]);
					vals.forEach(v => {
						pivot[attr][v] = pivot[attr][v] || {};
						pivot[attr][v][split] = { act: acts[v] || 0, req: reqs[v] || 0 };
					});
				});
			});
			attrOrder.forEach(attr => {
				if (!pivot[attr]) return; const values = Object.keys(pivot[attr]); if (values.length === 0) return;
				html += `<div class="table-wrap">
					<table class="preview-table details-table">
						<caption>${translateLabel(ATTR_LABELS_JA, attr)}</caption>
						<colgroup>
							<col class="col-value" />
							<col class="col-split" />
							<col class="col-split" />
							<col class="col-split" />
						</colgroup>
						<thead><tr><th>å€¤</th><th>TRAIN</th><th>VAL</th><th>TEST</th></tr></thead>
						<tbody>${values.map(v => {
							const cells = splitOrder.map(s => {
								const rec = (pivot[attr][v] && pivot[attr][v][s]) || {act:0, req:0};
								const label = `${rec.act}/${rec.req}`;
								let cls = 'cell-muted';
								if (rec.req > 0) { cls = rec.act >= rec.req ? 'cell-ok' : 'cell-need'; }
								else if (rec.act > 0) { cls = 'cell-extra'; }
								return `<td class="${cls}">${label}</td>`;
							}).join('');
							return `<tr><td>${translateLabel(VALUE_LABELS_JA, v)}</td>${cells}</tr>`;
						}).join('')}</tbody>
					</table>
				</div>`;
			});
			return html;
		}
		function displayPreviewResult(result) {
			// ãƒ‡ãƒãƒƒã‚°: ã‚µãƒ¼ãƒã‹ã‚‰ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
			try { console.log('[auto-split][preview] result:', result); } catch (_) {}
			const previewDiv = document.getElementById('splitPreview');
			// ã‚µãƒ¼ãƒãƒ¼ã®çµæœã‚’ãã®ã¾ã¾ã‚µãƒãƒªãƒ¼ã«åæ˜ ï¼ˆpreferæ™‚ã®ç´”åº¦å„ªå…ˆã‚„ãƒ—ãƒ¼ãƒ«ç¸®å°ã‚’å¿ å®Ÿã«è¡¨ç¤ºï¼‰
			const counts = { train: result.train_count || 0, val: result.val_count || 0, test: result.test_count || 0 };
			const serverTotal = result.total_images || 0;
			const total = serverTotal || (counts.train + counts.val + counts.test);
			const summaryHtml = renderSummaryTableFromCounts(total, counts);
			const totalText = total || 0;
			previewDiv.innerHTML = `<h4>ğŸ“Š åˆ†å‰²ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h4><p>å¯¾è±¡ç”»åƒ: <strong>${totalText}æš</strong></p>${summaryHtml}${renderDetailsTables(result.details)}<p style="margin-top: 15px; color: #666; font-size: 14px;">âš ï¸ å®Ÿè¡Œã™ã‚‹ã¨æ—¢å­˜ã®åˆ†å‰²è¨­å®šã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™</p>`;
			previewDiv.style.display = 'block';
			document.getElementById('splitResult').style.display = 'none';
		}
		function displayExecuteResult(result) {
			const resultDiv = document.getElementById('splitResult');
			resultDiv.innerHTML = `<h4>âœ… è‡ªå‹•åˆ†å‰²å®Œäº†</h4><p>${result.message}</p>`;
			resultDiv.style.display = 'block';
			document.getElementById('splitPreview').style.display = 'none';
		}
		document.addEventListener('DOMContentLoaded', () => {
			loadSavedAutoSplitSettings().then(() => computeAndRenderEstimate());
			loadEligibleCount();
			wireEstimateEvents();
		});
		</script>
	</div>
</body>
</html>
