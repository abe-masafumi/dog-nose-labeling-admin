<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>データエクスポート | 犬の鼻ラベリング管理ツール</title>
	<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
			padding-top: 80px; /* ヘッダー分の余白 */
		}
		.header {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 20px;
			border-radius: 10px;
			margin-bottom: 20px;
			text-align: center;
		}
		.header h1 {
			font-size: 2.5em;
			margin-bottom: 10px;
		}
		.header p {
			font-size: 1.1em;
			opacity: 0.9;
		}
        .auto-split-section {
			margin: 40px 0 0 0;
			padding: 24px;
			border: 2px solid #4CAF50;
			border-radius: 8px;
			background-color: #f9f9f9;
			max-width: 500px;
			margin-left: auto;
			margin-right: auto;
		}
		.percentage-inputs {
			display: flex;
			gap: 15px;
			margin-bottom: 15px;
			flex-wrap: wrap;
		}
		.input-group {
			display: flex;
			flex-direction: column;
			min-width: 100px;
		}
		.input-group label {
			font-weight: bold;
			margin-bottom: 5px;
			color: #333;
		}
		.input-group input {
			padding: 8px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 14px;
		}
		.auto-split-buttons {
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
			margin-top: 12px; /* 上に余白を追加 */
		}
		.preview-button, .auto-split-button {
			padding: 10px 20px;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			margin-top: 8px; /* 各ボタン個別にも上余白を付与 */
		}
		.preview-button {
			background-color: #2196F3;
			color: white;
		}
		.preview-button:hover {
			background-color: #1976D2;
		}
		.auto-split-button {
			background-color: #4CAF50;
			color: white;
		}
		.auto-split-button:hover {
			background-color: #45a049;
		}
		.auto-split-button:disabled {
			background-color: #cccccc;
			cursor: not-allowed;
		}
		.split-preview, .split-result {
			margin-top: 15px;
			padding: 15px;
			border-radius: 5px;
			background-color: white;
			border: 1px solid #ddd;
		}
		.split-preview {
			border-left: 4px solid #2196F3;
		}
		.split-result {
			border-left: 4px solid #4CAF50;
		}
		.preview-stats {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
			gap: 10px;
			margin-top: 10px;
		}
		.stat-item {
			text-align: center;
			padding: 10px;
			background-color: #f5f5f5;
			border-radius: 4px;
		}
		.stat-value {
			font-size: 18px;
			font-weight: bold;
			color: #333;
		}
		.stat-label {
			font-size: 12px;
			color: #666;
			margin-top: 5px;
		}

		/* --- Table styles for preview --- */
		.table-wrap {
			margin-top: 12px;
			overflow-x: auto;
		}
		table.preview-table {
			width: 100%;
			border-collapse: collapse;
			background: #fff;
			border: 1px solid #e5e7eb;
			border-radius: 6px;
			overflow: hidden;
		}
		.preview-table caption {
			text-align: left;
			font-weight: 700;
			padding: 10px 12px;
			background: #f3f4f6;
			border-bottom: 1px solid #e5e7eb;
		}
		.preview-table th, .preview-table td {
			padding: 8px 10px;
			border-bottom: 1px solid #f0f0f0;
			text-align: center;
			font-size: 13px;
			white-space: nowrap;
		}
		.preview-table th:first-child, .preview-table td:first-child {
			text-align: left;
		}
		.preview-table thead th {
			background: #fafafa;
			color: #374151;
			font-weight: 700;
		}
		.preview-table tbody tr:nth-child(odd) {
			background: #fcfcfc;
		}
		.cell-ok {
			background: #e8f5e9;
			color: #1b5e20;
			font-weight: 600;
			border-radius: 4px;
		}
		.cell-need {
			background: #ffebee;
			color: #b71c1c;
			font-weight: 600;
			border-radius: 4px;
		}
		.cell-extra {
			background: #fff8e1;
			color: #e65100;
			font-weight: 600;
			border-radius: 4px;
		}
		.cell-muted { color: #9ca3af; }
	</style>
</head>
<body>
	{% include 'header.html' with context %}
	<div class="container" style="padding-top:80px;">
		<div class="header">
			<h1>📁 データエクスポート</h1>
			<p>データセットのエクスポートや自動分割を行う画面です</p>
		</div>
		<div class="auto-split-section">
			<h2 style="text-align:center; margin-bottom:24px;">🎯 自動データセット分割</h2>
			<div class="auto-split-controls">
				<div class="percentage-inputs">
					<div class="input-group">
						<label for="trainPercent">Train (%)</label>
						<input type="number" id="trainPercent" value="80" min="0" max="100" step="0.1">
					</div>
					<div class="input-group">
						<label for="valPercent">Val (%)</label>
						<input type="number" id="valPercent" value="10" min="0" max="100" step="0.1">
					</div>
					<div class="input-group">
						<label for="testPercent">Test (%)</label>
						<input type="number" id="testPercent" value="10" min="0" max="100" step="0.1">
					</div>
				</div>
				<!-- 詳細ターゲットの設定 -->
				<div style="margin-top:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:12px;">
					<h4 style="margin-bottom:8px;">⚙️ 詳細ターゲット（任意）</h4>
					<p style="font-size:12px; color:#666; margin-bottom:8px;">各Splitに含めたい割合(%)を属性ごとに設定できます。未入力は無視されます。</p>
					<div id="targetControls" style="display:grid; grid-template-columns: 1fr; gap:10px;">
						<!-- クラス（鼻あり/鼻なし） -->
						<div>
							<div style="font-weight:600; margin-bottom:6px;">クラス</div>
							<div style="display:grid; grid-template-columns: auto 1fr; gap:8px; align-items:center;">
								<label>鼻あり</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_main_label_nose_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_main_label_nose_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_main_label_nose_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
								<label>鼻なし</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_main_label_none_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_main_label_none_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_main_label_none_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
							</div>
						</div>
						<!-- 向き -->
						<div>
							<div style="font-weight:600; margin-bottom:6px;">向き</div>
							<div style="display:grid; grid-template-columns: auto 1fr; gap:8px; align-items:center;">
								<label>正面</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_orientation_front_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_orientation_front_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_orientation_front_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
								<label>横向き</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_orientation_side_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_orientation_side_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_orientation_side_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
								<label>斜め</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_orientation_tilted_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_orientation_tilted_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_orientation_tilted_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
							</div>
						</div>
						<!-- 鮮明判定 -->
						<div>
							<div style="font-weight:600; margin-bottom:6px;">鮮明判定</div>
							<div style="display:grid; grid-template-columns: auto 1fr; gap:8px; align-items:center;">
								<label>鮮明</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_clarity_clear_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_clarity_clear_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_clarity_clear_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
								<label>ぼやけ</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_clarity_blurred_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_clarity_blurred_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_clarity_blurred_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
							</div>
						</div>
						<!-- 鼻の色 -->
						<div>
							<div style="font-weight:600; margin-bottom:6px;">鼻の色</div>
							<div style="display:grid; grid-template-columns: auto 1fr; gap:8px; align-items:center;">
								<label>黒</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_color_black_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_color_black_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_color_black_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
								<label>茶色</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_color_brown_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_color_brown_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_color_brown_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
								<label>灰色</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_color_gray_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_color_gray_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_color_gray_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
								<label>ピンク</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_color_pink_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_color_pink_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_color_pink_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>

								<label>マーブル</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_color_marble_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_color_marble_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_color_marble_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
							</div>
						</div>
						<!-- 他の属性（大きさ・毛色・鼻の長さ）は省略せず同様に定義 -->
						<div>
							<div style="font-weight:600; margin-bottom:6px;">鼻の大きさ</div>
							<div style="display:grid; grid-template-columns: auto 1fr; gap:8px; align-items:center;">
								<label>大きい</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_size_large_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_size_large_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_size_large_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
								<label>小さい</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_size_small_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_size_small_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_size_small_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
							</div>
						</div>
						<div>
							<div style="font-weight:600; margin-bottom:6px;">毛色</div>
							<div style="display:grid; grid-template-columns: auto 1fr; gap:8px; align-items:center;">
								<label>明るい毛色</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_fur_light_fur_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_fur_light_fur_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_fur_light_fur_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
								<label>暗い毛色</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_fur_dark_fur_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_fur_dark_fur_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_fur_dark_fur_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
							</div>
						</div>
						<div>
							<div style="font-weight:600; margin-bottom:6px;">鼻の長さ</div>
							<div style="display:grid; grid-template-columns: auto 1fr; gap:8px; align-items:center;">
								<label>長い</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_nose_length_nose_long_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_nose_length_nose_long_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_nose_length_nose_long_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
								<label>中</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_nose_length_nose_medium_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_nose_length_nose_medium_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_nose_length_nose_medium_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
								<label>短い</label>
								<div style="display:flex; gap:8px;">
									<input type="number" id="t_nose_length_nose_short_train" placeholder="Train%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_nose_length_nose_short_val" placeholder="Val%" min="0" max="100" step="0.1" style="width:90px;">
									<input type="number" id="t_nose_length_nose_short_test" placeholder="Test%" min="0" max="100" step="0.1" style="width:90px;">
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="auto-split-buttons">
					<button class="preview-button" onclick="previewAutoSplit()">📊 プレビュー</button>
					<button class="auto-split-button" onclick="executeAutoSplit()">🎯 自動分割実行</button>
				</div>
			</div>
			<div id="splitPreview" class="split-preview" style="display: none;"></div>
			<div id="splitResult" class="split-result" style="display: none;"></div>
		</div>
		<div class="export-section" style="max-width:500px; margin:40px auto 0; background:#fff; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.07); padding:32px 24px;">
			<h2 style="text-align:center; margin-bottom:24px;">📁 データエクスポート</h2>
			<div class="export-buttons" style="display:grid; grid-template-columns:1fr; gap:16px;">
				<button class="dataset-export" style="padding:16px; font-size:16px; background:#17a2b8; color:#fff; border:none; border-radius:6px; cursor:pointer;" onclick="exportDataset()">📁 データセットZIP出力</button>
			</div>
			<div style="margin-top:24px; text-align:center; color:#888; font-size:13px;">※「この画像だけデータセットZIP」はラベリング画面でのみ有効です</div>
		</div>
		<script>
		function exportDataset() {
			window.open('/api/export/dataset', '_blank');
		}
		function exportCurrentImageDataset() {
			alert('「この画像だけデータセットZIP」はラベリング画面でご利用ください。');
		}
		function applyTargetsToUI(targets) {
			if (!targets) return;
			const splits = ['train','val','test'];
			Object.keys(targets).forEach(attr => {
				const vals = targets[attr] || {};
				Object.keys(vals).forEach(val => {
					splits.forEach(s => {
						const v = vals[val] && vals[val][s];
						if (v === undefined || v === null) return;
						const el = document.getElementById(`t_${attr}_${val}_${s}`);
						if (el) el.value = v;
					});
				});
			});
		}
		async function loadSavedAutoSplitSettings() {
			try {
				const res = await fetch('/api/auto-split/settings');
				if (!res.ok) return;
				const conf = await res.json();
				document.getElementById('trainPercent').value = conf.train_percent ?? 80;
				document.getElementById('valPercent').value = conf.val_percent ?? 10;
				document.getElementById('testPercent').value = conf.test_percent ?? 10;
				applyTargetsToUI(conf.targets || {});
			} catch (e) {
				console.warn('設定読込に失敗:', e);
			}
		}

		function collectTargets() {
			// id規約: t_{attr}_{value}_{split}
			const attrs = ['main_label','orientation','clarity','color','size','fur','nose_length'];
			const splits = ['train','val','test'];
			const valuesMap = {
				main_label: ['nose','none'],
				orientation: ['front','side','tilted'],
				clarity: ['clear','blurred'],
				color: ['black','brown','gray','pink','marble'],
				size: ['large','small'],
				fur: ['light_fur','dark_fur'],
				nose_length: ['nose_long','nose_medium','nose_short']
			};
			const targets = {};
			attrs.forEach(attr => {
				const vals = valuesMap[attr];
				const conf = {};
				vals.forEach(val => {
					let any = false;
					const perSplit = {};
					splits.forEach(s => {
						const el = document.getElementById(`t_${attr}_${val}_${s}`);
						if (el && el.value !== '') {
							perSplit[s] = parseFloat(el.value);
							any = true;
						}
					});
					if (any) conf[val] = perSplit;
				});
				if (Object.keys(conf).length > 0) targets[attr] = conf;
			});
			return targets;
		}

		async function previewAutoSplit() {
			const trainPercent = parseFloat(document.getElementById('trainPercent').value);
			const valPercent = parseFloat(document.getElementById('valPercent').value);
			const testPercent = parseFloat(document.getElementById('testPercent').value);
			const total = trainPercent + valPercent + testPercent;
			if (Math.abs(total - 100) > 0.01) {
				alert(`割合の合計が100%になりません: ${total}%`);
				return;
			}
			if (trainPercent < 0 || valPercent < 0 || testPercent < 0) {
				alert('割合は0以上で入力してください');
				return;
			}
			const requestData = {
				train_percent: trainPercent,
				val_percent: valPercent,
				test_percent: testPercent,
				preview_only: true,
				targets: collectTargets()
			};
			const button = document.querySelector('.preview-button');
			const originalText = button.textContent;
			button.textContent = 'プレビュー中...';
			button.disabled = true;
			try {
				const response = await fetch('/api/auto-split', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(requestData)
				});
				const result = await response.json();
				if (response.ok) {
					displayPreviewResult(result);
				} else {
					alert(result.error || 'プレビューの取得に失敗しました');
				}
			} catch (error) {
				console.error('プレビューエラー:', error);
				alert('プレビューの取得に失敗しました');
			} finally {
				button.textContent = originalText;
				button.disabled = false;
			}
		}
		// 日本語ラベル
		const attrJa = {
			orientation: '向き',
			clarity: '鮮明判定',
			color: '鼻の色',
			size: '鼻の大きさ',
			fur: '毛色',
			nose_length: '鼻の長さ',
			main_label: 'クラス'
		};
		const valJa = {
			front: '正面', side: '横向き', tilted: '斜め',
			clear: '鮮明', blurred: 'ぼやけ',
			black: '黒', brown: '茶色', gray: '灰色', pink: 'ピンク', marble: 'マーブル',
			large: '大きい', small: '小さい',
			light_fur: '明るい毛色', dark_fur: '暗い毛色',
			nose_long: '長い', nose_medium: '中', nose_short: '短い',
			nose: '鼻あり', none: '鼻なし'
		};
		const toJa = (map, key) => map[key] || key;

		function renderSummaryTable(result) {
			const rows = [
				{ key: 'TRAIN', count: result.train_count, percent: result.train_percent_actual },
				{ key: 'VAL', count: result.val_count, percent: result.val_percent_actual },
				{ key: 'TEST', count: result.test_count, percent: result.test_percent_actual },
			];
			return `
			<div class="table-wrap">
				<table class="preview-table">
					<caption>分割サマリー</caption>
					<thead>
						<tr><th>Split</th><th>枚数</th><th>割合</th></tr>
					</thead>
					<tbody>
						${rows.map(r => `<tr><td>${r.key}</td><td>${r.count}枚</td><td>${r.percent}%</td></tr>`).join('')}
					</tbody>
				</table>
			</div>`;
		}

		function renderDetailsTables(details) {
			if (!details) return '';
			const splitOrder = ['train','val','test'];
			const attrOrder = ['orientation','clarity','color','size','fur','nose_length','main_label'];
			let html = '';
			// ピボット: attr -> value -> split -> {act, req}
			const pivot = {};
			splitOrder.forEach(split => {
				const attrs = details[split] || {};
				Object.keys(attrs).forEach(attr => {
					pivot[attr] = pivot[attr] || {};
					const reqs = (attrs[attr] && attrs[attr].required_counts) || {};
					const acts = (attrs[attr] && attrs[attr].actual_counts) || {};
					const vals = new Set([...Object.keys(reqs), ...Object.keys(acts)]);
					vals.forEach(v => {
						pivot[attr][v] = pivot[attr][v] || {};
						pivot[attr][v][split] = {
							act: acts[v] || 0,
							req: reqs[v] || 0
						};
					});
				});
			});
			// 属性ごとにテーブルを描画
			attrOrder.forEach(attr => {
				if (!pivot[attr]) return;
				const values = Object.keys(pivot[attr]);
				if (values.length === 0) return;
				html += `
				<div class="table-wrap">
					<table class="preview-table">
						<caption>${toJa(attrJa, attr)}</caption>
						<thead>
							<tr>
								<th>値</th>
								<th>TRAIN</th>
								<th>VAL</th>
								<th>TEST</th>
							</tr>
						</thead>
						<tbody>
							${values.map(v => {
								const cells = splitOrder.map(s => {
									const rec = (pivot[attr][v] && pivot[attr][v][s]) || {act:0, req:0};
									const label = `${rec.act}/${rec.req}`;
									let cls = 'cell-muted';
									if (rec.req > 0) {
										cls = rec.act >= rec.req ? 'cell-ok' : 'cell-need';
									} else if (rec.act > 0) {
										cls = 'cell-extra';
									}
									return `<td class="${cls}">${label}</td>`;
								}).join('');
								return `<tr><td>${toJa(valJa, v)}</td>${cells}</tr>`;
							}).join('')}
						</tbody>
					</table>
				</div>`;
			});
			return html;
		}

		function displayPreviewResult(result) {
			const previewDiv = document.getElementById('splitPreview');
			previewDiv.innerHTML = `
				<h4>📊 分割プレビュー</h4>
				<p>クラス設定済み画像: <strong>${result.total_images}枚</strong></p>
				${renderSummaryTable(result)}
				${renderDetailsTables(result.details)}
				<p style="margin-top: 15px; color: #666; font-size: 14px;">
					⚠️ 実行すると既存の分割設定は上書きされます
				</p>
			`;
			previewDiv.style.display = 'block';
			document.getElementById('splitResult').style.display = 'none';
		}
		async function executeAutoSplit() {
			const trainPercent = parseFloat(document.getElementById('trainPercent').value);
			const valPercent = parseFloat(document.getElementById('valPercent').value);
			const testPercent = parseFloat(document.getElementById('testPercent').value);
			const total = trainPercent + valPercent + testPercent;
			if (Math.abs(total - 100) > 0.01) {
				alert(`割合の合計が100%になりません: ${total}%`);
				return;
			}
			if (trainPercent < 0 || valPercent < 0 || testPercent < 0) {
				alert('割合は0以上で入力してください');
				return;
			}
			const requestData = {
				train_percent: trainPercent,
				val_percent: valPercent,
				test_percent: testPercent,
				overwrite_existing: true,
				targets: collectTargets()
			};
			const confirmMessage = `クラス設定済みの全ての画像を以下の割合で分割します:\nTrain: ${trainPercent}%\nVal: ${valPercent}%\nTest: ${testPercent}%\n\n既存の分割設定も上書きされます。実行しますか？`;
			if (!confirm(confirmMessage)) {
				return;
			}
			const button = document.querySelector('.auto-split-button');
			const originalText = button.textContent;
			button.textContent = '分割中...';
			button.disabled = true;
			try {
				const response = await fetch('/api/auto-split', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(requestData)
				});
				const result = await response.json();
				if (response.ok) {
					displayExecuteResult(result);
				} else {
					alert(result.error || '自動分割に失敗しました');
				}
			} catch (error) {
				console.error('自動分割エラー:', error);
				alert('自動分割に失敗しました');
			} finally {
				button.textContent = originalText;
				button.disabled = false;
			}
		}
		function displayExecuteResult(result) {
			const resultDiv = document.getElementById('splitResult');
			resultDiv.innerHTML = `
				<h4>✅ 自動分割完了</h4>
				<p>${result.message}</p>
			`;
			resultDiv.style.display = 'block';
			document.getElementById('splitPreview').style.display = 'none';
		}
				document.addEventListener('DOMContentLoaded', () => {
					loadSavedAutoSplitSettings();
				});
		</script>
	</div>
</body>
</html>
